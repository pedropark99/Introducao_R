<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="pt-BR" xml:lang="pt-BR"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.554">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Introdução à Linguagem R - 16&nbsp; Functional programming com purrr</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 1em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../Capítulos/15-debugging.html" rel="next">
<link href="../Capítulos/17-loops.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "Nenhum resultado",
    "search-matching-documents-text": "documentos correspondentes",
    "search-copy-link-title": "Copiar link para a busca",
    "search-hide-matches-text": "Esconder correspondências adicionais",
    "search-more-match-text": "mais correspondência neste documento",
    "search-more-matches-text": "mais correspondências neste documento",
    "search-clear-button-title": "Limpar",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancelar",
    "search-submit-button-title": "Enviar",
    "search-label": "Procurar"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Alternar barra lateral" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../Capítulos/13-controle-fluxo.html">Funções e Loops: construindo os seus próprios programas e automatizando tarefas</a></li><li class="breadcrumb-item"><a href="../Capítulos/18-purrr.html"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title"><em>Functional programming</em> com <code>purrr</code></span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Alternar barra lateral" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">Introdução à Linguagem R</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Procurar"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Prefácio</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Introduzindo a Linguagem R</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Alternar seção">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Capítulos/01-nocoes-basicas.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Noções Básicas do R</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Capítulos/02-fundamentos.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Fundamentos da Linguagem R</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">Importando, organizando e transformando dados</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Alternar seção">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Capítulos/03-tidyverse.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Introduzindo o universo do <code>tidyverse</code></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Capítulos/03-importacao.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Importando e exportando dados com <code>readr</code>, <code>readxl</code> e <code>haven</code></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Capítulos/04-transformacao.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Transformando dados com <code>dplyr</code></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Capítulos/06-dados-relacionais.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Introdução a base de dados relacionais com <code>dplyr</code></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Capítulos/07-tidy-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title"><em>Tidy Data</em>: uma abordagem para organizar os seus dados com <code>tidyr</code></span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">Visualizando seus dados</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Alternar seção">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Capítulos/08-ggplot.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Visualização de dados com <code>ggplot2</code></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Capítulos/09-theme-ggplot.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Configurando componentes estéticos do gráfico no <code>ggplot2</code></span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
 <span class="menu-text">Ferramentas para tipos específicos de dados</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true" aria-label="Alternar seção">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Capítulos/10-strings.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Manipulação e transformação de <em>strings</em> com <code>stringr</code></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Capítulos/11-factors.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Introduzindo fatores (<em>factor</em>’s) com <code>forcats</code></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Capítulos/12-variaveis-tempo.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Introdução à variáveis de tempo com <code>lubridate</code></span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">
 <span class="menu-text">Funções e Loops: construindo os seus próprios programas e automatizando tarefas</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true" aria-label="Alternar seção">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Capítulos/13-controle-fluxo.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Controle condicional de fluxo</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Capítulos/05-funcoes-loops.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Funções</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Capítulos/17-loops.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title"><em>Loops</em></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Capítulos/18-purrr.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title"><em>Functional programming</em> com <code>purrr</code></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Capítulos/15-debugging.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title"><em>Debugging</em> - Resolvendo <em>bugs</em> em suas funções</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Capítulos/16-environments.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title"><em>Environments</em> ou ambientes no R</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true">
 <span class="menu-text">Apêndices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true" aria-label="Alternar seção">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Capítulos/exercises.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Exercícios</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Capítulos/references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Referências bibliográficas</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Índice</h2>
   
  <ul>
  <li><a href="#introdução" id="toc-introdução" class="nav-link active" data-scroll-target="#introdução"><span class="header-section-number">16.1</span> Introdução</a></li>
  <li><a href="#loops-implícitos-com-a-família-map" id="toc-loops-implícitos-com-a-família-map" class="nav-link" data-scroll-target="#loops-implícitos-com-a-família-map"><span class="header-section-number">16.2</span> <em>Loops</em> implícitos com a família <code>map</code></a>
  <ul class="collapse">
  <li><a href="#a-família-de-funções-map" id="toc-a-família-de-funções-map" class="nav-link" data-scroll-target="#a-família-de-funções-map"><span class="header-section-number">16.2.1</span> A família de funções <code>map()</code></a></li>
  <li><a href="#no-fundo-estamos-utilizando-um-for-loop" id="toc-no-fundo-estamos-utilizando-um-for-loop" class="nav-link" data-scroll-target="#no-fundo-estamos-utilizando-um-for-loop"><span class="header-section-number">16.2.2</span> No fundo, estamos utilizando um <code>for</code> <em>loop</em></a></li>
  <li><a href="#se-não-existe-uma-solução-pronta-no-r-crie-a-sua-própria" id="toc-se-não-existe-uma-solução-pronta-no-r-crie-a-sua-própria" class="nav-link" data-scroll-target="#se-não-existe-uma-solução-pronta-no-r-crie-a-sua-própria"><span class="header-section-number">16.2.3</span> Se não existe uma solução pronta no R, crie a sua própria</a></li>
  <li><a href="#alguns-atalhos-úteis-das-funções-map" id="toc-alguns-atalhos-úteis-das-funções-map" class="nav-link" data-scroll-target="#alguns-atalhos-úteis-das-funções-map"><span class="header-section-number">16.2.4</span> Alguns atalhos úteis das funções <code>map</code></a></li>
  </ul></li>
  <li><a href="#um-estudo-de-caso-aplicando-um-modelo-econométrico-sobre-diferentes-países" id="toc-um-estudo-de-caso-aplicando-um-modelo-econométrico-sobre-diferentes-países" class="nav-link" data-scroll-target="#um-estudo-de-caso-aplicando-um-modelo-econométrico-sobre-diferentes-países"><span class="header-section-number">16.3</span> Um estudo de caso: aplicando um modelo econométrico sobre diferentes países</a>
  <ul class="collapse">
  <li><a href="#a-função-que-calcula-o-modelo-econométrico" id="toc-a-função-que-calcula-o-modelo-econométrico" class="nav-link" data-scroll-target="#a-função-que-calcula-o-modelo-econométrico"><span class="header-section-number">16.3.1</span> A função que calcula o modelo econométrico</a></li>
  <li><a href="#criando-uma-lista-de-data.frames" id="toc-criando-uma-lista-de-data.frames" class="nav-link" data-scroll-target="#criando-uma-lista-de-data.frames"><span class="header-section-number">16.3.2</span> Criando uma lista de <code>data.frame</code>’s</a></li>
  <li><a href="#com-a-função-split" id="toc-com-a-função-split" class="nav-link" data-scroll-target="#com-a-função-split"><span class="header-section-number">16.3.3</span> Com a função <code>split()</code></a></li>
  <li><a href="#com-a-função-nest" id="toc-com-a-função-nest" class="nav-link" data-scroll-target="#com-a-função-nest"><span class="header-section-number">16.3.4</span> Com a função <code>nest()</code></a></li>
  </ul></li>
  <li><a href="#comparando-a-família-map-à-família-apply" id="toc-comparando-a-família-map-à-família-apply" class="nav-link" data-scroll-target="#comparando-a-família-map-à-família-apply"><span class="header-section-number">16.4</span> Comparando a família <code>map</code> à família <code>apply</code></a></li>
  <li><a href="#identificando-erros-nas-funções-map" id="toc-identificando-erros-nas-funções-map" class="nav-link" data-scroll-target="#identificando-erros-nas-funções-map"><span class="header-section-number">16.5</span> Identificando erros nas funções <code>map</code></a></li>
  <li><a href="#compreendendo-as-funções-map_dfr-e-map_dfc" id="toc-compreendendo-as-funções-map_dfr-e-map_dfc" class="nav-link" data-scroll-target="#compreendendo-as-funções-map_dfr-e-map_dfc"><span class="header-section-number">16.6</span> Compreendendo as funções <code>map_dfr()</code> e <code>map_dfc()</code></a></li>
  <li><a href="#sec:demanda_dist_ICMS" id="toc-sec:demanda_dist_ICMS" class="nav-link" data-scroll-target="#sec\:demanda_dist_ICMS"><span class="header-section-number">16.7</span> Um estudo de caso: uma demanda real sobre a distribuição de ICMS</a>
  <ul class="collapse">
  <li><a href="#a-demanda-em-si" id="toc-a-demanda-em-si" class="nav-link" data-scroll-target="#a-demanda-em-si"><span class="header-section-number">16.7.1</span> A demanda em si</a></li>
  <li><a href="#planejando-os-passos" id="toc-planejando-os-passos" class="nav-link" data-scroll-target="#planejando-os-passos"><span class="header-section-number">16.7.2</span> Planejando os passos</a></li>
  <li><a href="#importando-as-planilhas" id="toc-importando-as-planilhas" class="nav-link" data-scroll-target="#importando-as-planilhas"><span class="header-section-number">16.7.3</span> Importando as planilhas</a></li>
  <li><a href="#conferindo-a-estrutura-dos-arquivos" id="toc-conferindo-a-estrutura-dos-arquivos" class="nav-link" data-scroll-target="#conferindo-a-estrutura-dos-arquivos"><span class="header-section-number">16.7.4</span> Conferindo a estrutura dos arquivos</a></li>
  <li><a href="#adicionando-colunas-de-referência" id="toc-adicionando-colunas-de-referência" class="nav-link" data-scroll-target="#adicionando-colunas-de-referência"><span class="header-section-number">16.7.5</span> Adicionando colunas de referência</a></li>
  <li><a href="#selecionando-apenas-as-colunas-relevantes" id="toc-selecionando-apenas-as-colunas-relevantes" class="nav-link" data-scroll-target="#selecionando-apenas-as-colunas-relevantes"><span class="header-section-number">16.7.6</span> Selecionando apenas as colunas relevantes</a></li>
  <li><a href="#unindo-as-12-planilhas-em-uma-só" id="toc-unindo-as-12-planilhas-em-uma-só" class="nav-link" data-scroll-target="#unindo-as-12-planilhas-em-uma-só"><span class="header-section-number">16.7.7</span> Unindo as 12 planilhas em uma só</a></li>
  <li><a href="#conclusão" id="toc-conclusão" class="nav-link" data-scroll-target="#conclusão"><span class="header-section-number">16.7.8</span> Conclusão</a></li>
  </ul></li>
  <li><a href="#iterando-sobre-vários-inputs-simultaneamente" id="toc-iterando-sobre-vários-inputs-simultaneamente" class="nav-link" data-scroll-target="#iterando-sobre-vários-inputs-simultaneamente"><span class="header-section-number">16.8</span> Iterando sobre vários <em>input</em>’s simultaneamente</a>
  <ul class="collapse">
  <li><a href="#utilizando-dois-inputs" id="toc-utilizando-dois-inputs" class="nav-link" data-scroll-target="#utilizando-dois-inputs"><span class="header-section-number">16.8.1</span> Utilizando dois <em>input</em>’s</a></li>
  <li><a href="#utilizando-n-inputs" id="toc-utilizando-n-inputs" class="nav-link" data-scroll-target="#utilizando-n-inputs"><span class="header-section-number">16.8.2</span> Utilizando <span class="math inline">\(n\)</span> <em>input</em>’s</a></li>
  </ul></li>
  <li><a href="#a-família-walk" id="toc-a-família-walk" class="nav-link" data-scroll-target="#a-família-walk"><span class="header-section-number">16.9</span> A família <code>walk()</code></a></li>
  <li><a href="#agregando-resultados-com-reduce" id="toc-agregando-resultados-com-reduce" class="nav-link" data-scroll-target="#agregando-resultados-com-reduce"><span class="header-section-number">16.10</span> Agregando resultados com <code>reduce()</code></a></li>
  <li><a href="#acumulando-resultados-com-accumulate" id="toc-acumulando-resultados-com-accumulate" class="nav-link" data-scroll-target="#acumulando-resultados-com-accumulate"><span class="header-section-number">16.11</span> Acumulando resultados com <code>accumulate()</code></a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../Capítulos/13-controle-fluxo.html">Funções e Loops: construindo os seus próprios programas e automatizando tarefas</a></li><li class="breadcrumb-item"><a href="../Capítulos/18-purrr.html"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title"><em>Functional programming</em> com <code>purrr</code></span></a></li></ol></nav>
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title"><em>Functional programming</em> com <code>purrr</code></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="introdução" class="level2" data-number="16.1">
<h2 data-number="16.1" class="anchored" data-anchor-id="introdução"><span class="header-section-number">16.1</span> Introdução</h2>
<p>Neste capítulo, vamos introduzir um outro pacote do <code>tidyverse</code>, chamado de <code>purrr</code>. Esse pacote provê um conjunto de ferramentas que ampliam as funcionalidades de <em>functional programming</em> do R. Para ter acesso às funções desse pacote, você pode chamar tanto pelo <code>tidyverse</code> quanto pelo <code>purrr</code> diretamente.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(purrr)</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="loops-implícitos-com-a-família-map" class="level2" data-number="16.2">
<h2 data-number="16.2" class="anchored" data-anchor-id="loops-implícitos-com-a-família-map"><span class="header-section-number">16.2</span> <em>Loops</em> implícitos com a família <code>map</code></h2>
<p>A principal fraqueza de um <code>for</code> <em>loop</em> é que ele foca demasiada atenção sobre os objetos envolvidos na iteração. Isso por um lado é bom, pois você consegue identificar todas as “dependências” de um <code>for</code> <em>loop</em>, mas, por um outro lado, é ruim. Pois na maioria das vezes, é muito mais importante identificarmos a ação, a transformação ou a funcionalidade que está sendo aplicada sobre esses objetos em cada iteração.</p>
<p>Por exemplo, abaixo temos dois <code>for</code> <em>loops</em> diferentes que aplicam uma determinada operação sobre o objeto <code>tab</code>. O que cada <code>for</code> <em>loop</em> abaixo está fazendo? Qual a diferença entre eles? Após observá-los por um tempo você vai acabar percebendo que a única diferença entre esses dois <code>for</code> <em>loops</em> está na função que está sendo aplicada sobre cada coluna de <code>tab</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>tab <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1 =</span> <span class="fu">rnorm</span>(<span class="dv">10</span>),</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">x2 =</span> <span class="fu">rnorm</span>(<span class="dv">10</span>),</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">x3 =</span> <span class="fu">rnorm</span>(<span class="dv">10</span>),</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">x4 =</span> <span class="fu">rnorm</span>(<span class="dv">10</span>)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>vec1 <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">"double"</span>, <span class="at">length =</span> <span class="fu">ncol</span>(tab))</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="fu">seq_along</span>(tab)){</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>  vec1[i] <span class="ot">&lt;-</span> <span class="fu">mean</span>(tab[[i]], <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>vec2 <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">"double"</span>, <span class="at">length =</span> <span class="fu">ncol</span>(tab))</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="fu">seq_along</span>(tab)){</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>  vec2[i] <span class="ot">&lt;-</span> <span class="fu">median</span>(tab[[i]], <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(vec1)</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -0.3913587  0.1314754  0.3503364 -0.2765988</code></pre>
</div>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(vec2)</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -0.5219914  0.5606106  0.6669979 -0.2361631</code></pre>
</div>
</div>
<p>É esse o problema que a família de funções <code>map</code> busca solucionar, ao nos fornecer um meio de construirmos <em>loops</em> em um formato mais funcional, destacando assim, as transformações e funções que estamos aplicando em cada repetição, ao invés dos objetos envolvidos na iteração. Como exemplo, podemos replicar o mesmo exemplo de <code>for</code> <em>loops</em> acima, utilizando a família de funções <code>map</code>, da seguinte forma:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(purrr)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>vec1 <span class="ot">&lt;-</span> <span class="fu">map_dbl</span>(tab, mean, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>vec2 <span class="ot">&lt;-</span> <span class="fu">map_dbl</span>(tab, median, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(vec1)</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        x1         x2         x3         x4 
-0.3913587  0.1314754  0.3503364 -0.2765988 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(vec2)</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        x1         x2         x3         x4 
-0.5219914  0.5606106  0.6669979 -0.2361631 </code></pre>
</div>
</div>
<p>Perceba acima, o quão simples e sucinto é para expressarmos uma operação com a família <code>map</code>. Vamos explicar daqui a pouco, em detalhes como essas funções funcionam. Por enquanto, quero apenas destacar que agora com a função <code>map_dbl()</code>, está muito fácil de identificarmos a diferença entre os dois <em>loops</em> acima. Pois a única coisa que está de fato mudando entre uma linha e outra, é a função aplicada sobre cada coluna de <code>tab</code>, que são as funções <code>mean()</code> e <code>median()</code>. Dessa forma, você pode rapidamente entender que o primeiro <em>loop</em> está calculando a média de cada coluna, enquanto o segundo <em>loop</em>, está calculando a mediana.</p>
<section id="a-família-de-funções-map" class="level3" data-number="16.2.1">
<h3 data-number="16.2.1" class="anchored" data-anchor-id="a-família-de-funções-map"><span class="header-section-number">16.2.1</span> A família de funções <code>map()</code></h3>
<p>Portanto, o pacote <code>purrr</code> nos oferece a família de funções <code>map</code>, a qual possui 7 membros diferentes, sendo eles:</p>
<ul>
<li><code>map()</code>: retorna uma lista.</li>
<li><code>map_dbl()</code>: retorna um vetor atômico do tipo <code>double</code>.</li>
<li><code>map_chr()</code>: retorna um vetor atômico do tipo <code>character</code>.</li>
<li><code>map_int()</code>: retorna um vetor atômico do tipo <code>integer</code>.</li>
<li><code>map_lgl()</code>: retorna um vetor atômico do tipo <code>logical</code>.</li>
<li><code>map_dfr()</code> e <code>map_dfc()</code>: retornam um <code>data.frame</code>.</li>
</ul>
<p>Todas essas 7 funções possuem os mesmos argumentos e realizam exatamente o mesmo trabalho. A única diferença entre elas, está na estrutura de dado em que o resultado é retornado. Tal estrutura é identificada pelo sufixo presente no nome de cada função. Portanto, todas essas funções <code>map</code> aceitam um objeto como <em>input</em>, e retornam como <em>output</em>, um novo objeto de mesmo comprimento que o objeto de <em>input</em>, e na estrutura identificada pelo sufixo no nome da função <span class="citation" data-cites="wickham2017">(<a href="references.html#ref-wickham2017" role="doc-biblioref">WICKHAM; GROLEMUND, 2017</a>)</span>.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-map-simples" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-map-simples-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./../Figuras/map_simple.png" class="img-fluid figure-img" style="width:70.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-map-simples-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figura&nbsp;16.1: Representação simples da tarefa executada por <code>map_dbl()</code>
</figcaption>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<div id="fig-map" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-map-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./../Figuras/map.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-map-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figura&nbsp;16.2: Representação mais detalhada da tarefa executada por <code>map_dbl()</code>
</figcaption>
</figure>
</div>
</div>
</div>
<p>Toda função <code>map</code> possui 3 argumentos principais, sendo eles: 1) <code>.x</code>, que é o objeto sobre o qual <code>map</code> vai iterar, ou, sobre o qual ela vai aplicar o <em>loop</em>; 2) <code>.f</code>, que é a função a ser aplicada sobre cada elemento de <code>.x</code>; e 3) <code>...</code>, que é a lista de argumentos a serem repassados para a função definida em <code>.f</code>.</p>
<p>Em resumo, todas as funções <code>map</code> buscam aplicar a função definida em <code>.f</code> sobre cada elemento do objeto <code>.x</code>. Consequentemente, o resultado de toda função <code>map</code> é um novo objeto contendo os resultados da função definida em <code>.f</code> aplicada sobre cada elemento do objeto definido em <code>.x</code>. Tal ação, está representada na <a href="#fig-map-simples" class="quarto-xref">Figura&nbsp;<span>16.1</span></a>.</p>
<p>Portanto, no exemplo anterior, em que aplicamos a função <code>map_dbl()</code> sobre o objeto <code>tab</code>, o que <code>map_dbl()</code> fez, foi criar um <em>loop</em> para aplicar as funções <code>mean()</code> e <code>median()</code> sobre cada elemento de <code>tab</code>. Como <code>tab</code> é um <code>data.frame</code>, cada elemento desse objeto corresponde a uma coluna do <code>data.frame</code>. A medida em que as funções <code>mean()</code> e <code>median()</code> foram sendo aplicadas sobre cada coluna de <code>tab</code>, a função <code>map_dbl()</code> foi coletando e armazenando os seus resultados em um vetor atômico do tipo <code>double</code>. Por fim, a função <code>map_dbl()</code> nos retorna como <em>output</em>, este vetor atômico contendo todos os resultados gerados. A <a href="#fig-map" class="quarto-xref">Figura&nbsp;<span>16.2</span></a> apresenta esse processo de forma mais detalhada.</p>
</section>
<section id="no-fundo-estamos-utilizando-um-for-loop" class="level3" data-number="16.2.2">
<h3 data-number="16.2.2" class="anchored" data-anchor-id="no-fundo-estamos-utilizando-um-for-loop"><span class="header-section-number">16.2.2</span> No fundo, estamos utilizando um <code>for</code> <em>loop</em></h3>
<p>No fim das contas, todas as funções <code>map</code> utilizam em algum momento um <code>for</code> <em>loop</em> para aplicar a função <code>.f</code> sobre cada elemento do objeto <code>.x</code>. Um detalhe é que essas funções constroem esse <code>for</code> <em>loop</em> em C, com o objetivo de gerar máxima performance. A título de ilustração, poderíamos reproduzir em R a definição da função <code>map()</code>, da seguinte forma:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>map <span class="ot">&lt;-</span> <span class="cf">function</span>(.x, .f, ...){</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  resultados <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">"list"</span>, <span class="at">length =</span> <span class="fu">length</span>(.x))</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="fu">seq_along</span>(.x)){</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    resultados[[i]] <span class="ot">&lt;-</span> <span class="fu">.f</span>(.x[[i]], ...)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(resultados)</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="fu">map</span>(tab, mean, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
[1] -0.3913587

[[2]]
[1] 0.1314754

[[3]]
[1] 0.3503364

[[4]]
[1] -0.2765988</code></pre>
</div>
</div>
<p>Com essa definição em mente, você também pode rapidamente atribuir as diferenças entre as funções <code>map()</code>, <code>map_dbl()</code>, e todas as demais funções <code>map</code>, à primeira linha dessa definição com a função <code>vector()</code>. Ou seja, a diferença principal entre as funções <code>map()</code> e <code>map_dbl()</code> (ou qualquer outra das funções <code>map</code>) é o tipo de vetor criado pela função <code>vector()</code>. Tal diferença está marcada na <a href="#fig-dif-map" class="quarto-xref">Figura&nbsp;<span>16.3</span></a>.</p>
<p>Sendo assim, todas as funções <code>map</code> ainda dependem de um <code>for</code> <em>loop</em> para realizar o seu trabalho. Porém, essas funções assumem o trabalho duro de criar esse <code>for</code> <em>loop</em> por você. Como resultado, você economiza parte de seu tempo, e deixa a intenção de seu código mais clara.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-dif-map" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-dif-map-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./../Figuras/dif_map.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-dif-map-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figura&nbsp;16.3: Diferenças entre as definições das funções <code>map</code>
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="se-não-existe-uma-solução-pronta-no-r-crie-a-sua-própria" class="level3" data-number="16.2.3">
<h3 data-number="16.2.3" class="anchored" data-anchor-id="se-não-existe-uma-solução-pronta-no-r-crie-a-sua-própria"><span class="header-section-number">16.2.3</span> Se não existe uma solução pronta no R, crie a sua própria</h3>
<p>Um dos grandes poderes das funções <code>map</code>, é que elas te ajudam a aplicar as suas ações sobre múltiplos <em>inputs</em> diferentes. Por “suas ações”, quero destacar que, se você não possui uma função já pronta no R que execute a ação que você deseja aplicar sobre cada elemento de seu objeto, você pode muito bem criar uma função personalizada, que aplique exatamente essa ação da forma como você deseja. Replicar depois essa função personalizada para os demais <em>inputs</em> se torna um passo muito simples com as funções <code>map</code>.</p>
<p>Por exemplo, imagine que você tenha uma lista como o objeto <code>l</code> abaixo, onde cada elemento é uma nova lista que pode conter um número variável de elementos. Agora, imagine que você queira identificar quais elementos dessa lista possuem <code>NA</code>’s. Nesse caso, você pode criar uma função como a <code>tem_na()</code> abaixo, que aceita uma lista como <em>input</em>, e utiliza as funções <code>is.na()</code> e <code>any()</code> para descobrir se algum dos elementos dessa lista contém um valor <code>NA</code>. Em seguida, podemos simplesmente replicar essa função para cada elemento da lista <code>l</code> com a função <code>map_lgl()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>tem_na <span class="ot">&lt;-</span> <span class="cf">function</span>(x){</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  teste <span class="ot">&lt;-</span> <span class="fu">is.na</span>(x)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  resultado <span class="ot">&lt;-</span> <span class="fu">any</span>(teste)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(resultado)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>l <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="cn">NA</span>),</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="dv">24</span>, <span class="dv">12</span>),</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="dv">21</span>, <span class="cn">NA</span>, <span class="dv">4</span>),</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="dv">56</span>, <span class="dv">19</span>, <span class="dv">20</span>, <span class="dv">43</span>)</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>vec <span class="ot">&lt;-</span> <span class="fu">map_lgl</span>(l, tem_na)</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>vec</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1]  TRUE FALSE  TRUE FALSE</code></pre>
</div>
</div>
</section>
<section id="alguns-atalhos-úteis-das-funções-map" class="level3" data-number="16.2.4">
<h3 data-number="16.2.4" class="anchored" data-anchor-id="alguns-atalhos-úteis-das-funções-map"><span class="header-section-number">16.2.4</span> Alguns atalhos úteis das funções <code>map</code></h3>
<p>Existem alguns atalhos úteis que você pode utilizar ao definir o argumento <code>.f</code> nas funções <code>map</code>. Por exemplo, suponha que você possua uma lista com várias informações referentes a um determinado aluno. Caso você precise coletar as idades de cada aluno em um vetor atômico por exemplo, você poderia fornecer à função <code>map_dbl()</code>, uma função anônima responsável por extrair o item <code>idade</code> de uma lista de <em>input</em>, como demonstrado abaixo.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>alunos <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">Ana =</span> <span class="fu">list</span>(<span class="at">idade =</span> <span class="dv">15</span>, <span class="at">altura =</span> <span class="fl">1.67</span>),</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">Bruno =</span> <span class="fu">list</span>(<span class="at">idade =</span> <span class="dv">17</span>, <span class="at">altura =</span> <span class="fl">1.75</span>),</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">Amanda =</span> <span class="fu">list</span>(<span class="at">idade =</span> <span class="dv">21</span>, <span class="at">altura =</span> <span class="fl">1.88</span>),</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">Eduardo =</span> <span class="fu">list</span>(<span class="at">idade =</span> <span class="dv">14</span>, <span class="at">altura =</span> <span class="fl">1.62</span>)</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>alunos <span class="sc">%&gt;%</span> </span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map_dbl</span>(<span class="cf">function</span>(x) x<span class="sc">$</span>idade)</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    Ana   Bruno  Amanda Eduardo 
     15      17      21      14 </code></pre>
</div>
</div>
<p>Apesar de bem prático escrevermos uma função anônima dessa forma, podemos utilizar uma notação ainda mais simples. Tal notação consiste em utilizar um til (<code>~</code>) como uma abreviação para a declaração da função anônima, e um ponto final (<code>.</code>) para determinar onde o argumento será posicionado no corpo dessa função anônima. Tendo isso em mente, poderíamos reproduzir o exemplo acima, da seguinte forma:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>alunos <span class="sc">%&gt;%</span> </span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map_dbl</span>(<span class="sc">~</span>.<span class="sc">$</span>idade)</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    Ana   Bruno  Amanda Eduardo 
     15      17      21      14 </code></pre>
</div>
</div>
<p>Portanto, o til substitui de certa forma a palavra-chave <code>function</code>, e o ponto final representa o argumento da função, ou, o elemento sobre o qual a função será aplicada. Contudo, como esse processo de extrair informações específicas de uma lista é algo muito comum, as funções <code>map</code> também oferecem um outro atalho, que seria o uso de uma <em>string</em>. Logo, se você deseja extrair um item de uma lista presente em cada elemento de um objeto, você pode simplesmente fornecer o nome desse item em uma <em>string</em> à função <code>map</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>alunos <span class="sc">%&gt;%</span> </span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map_dbl</span>(<span class="st">"idade"</span>)</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    Ana   Bruno  Amanda Eduardo 
     15      17      21      14 </code></pre>
</div>
</div>
</section>
</section>
<section id="um-estudo-de-caso-aplicando-um-modelo-econométrico-sobre-diferentes-países" class="level2" data-number="16.3">
<h2 data-number="16.3" class="anchored" data-anchor-id="um-estudo-de-caso-aplicando-um-modelo-econométrico-sobre-diferentes-países"><span class="header-section-number">16.3</span> Um estudo de caso: aplicando um modelo econométrico sobre diferentes países</h2>
<p>Nessa seção, vamos reproduzir o famoso exemplo dado por Hadley Wickham em sua palestra <em>“Managing many models with R”</em>. Pois esse exemplo demonstra bem, como as funções <code>map</code> ampliam as nossas capacidades com a linguagem R. Tal exemplo, começa pelo dataset <code>gapminder</code>, disponível através do pacote <code>gapminder</code>. Esse dataset contém dados de expectativa de vida (<code>lifeExp</code>), população (<code>pop</code>) e PIB per capita (<code>gdpPercap</code>) de diversos países do mundo (<code>country</code>), ao longo de vários anos (<code>year</code>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gapminder)</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>gapminder</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1,704 × 6
  country     continent  year lifeExp      pop gdpPercap
  &lt;fct&gt;       &lt;fct&gt;     &lt;int&gt;   &lt;dbl&gt;    &lt;int&gt;     &lt;dbl&gt;
1 Afghanistan Asia       1952    28.8  8425333      779.
2 Afghanistan Asia       1957    30.3  9240934      821.
3 Afghanistan Asia       1962    32.0 10267083      853.
4 Afghanistan Asia       1967    34.0 11537966      836.
5 Afghanistan Asia       1972    36.1 13079460      740.
# ℹ 1,699 more rows</code></pre>
</div>
</div>
<p>Repare abaixo, que esse dataset contém dados de 142 países diferentes, ao longo de 5 continentes do mundo. Dentre esses vários países, temos uma expectativa de vida estimada que varia de 23,59 até 82,60 anos, e um PIB per capita de 241 até 113.523 dólares.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>dplyr<span class="sc">::</span><span class="fu">n_distinct</span>(gapminder<span class="sc">$</span>country)</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 142</code></pre>
</div>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>dplyr<span class="sc">::</span><span class="fu">n_distinct</span>(gapminder<span class="sc">$</span>continent)</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 5</code></pre>
</div>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">range</span>(gapminder<span class="sc">$</span>lifeExp)</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 23.599 82.603</code></pre>
</div>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">range</span>(gapminder<span class="sc">$</span>gdpPercap)</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1]    241.1659 113523.1329</code></pre>
</div>
</div>
<p>Com esses dados em mãos, podemos utilizar um modelo econométrico para tentar explicar a expectativa de vida da população de cada país com base no seu PIB per capita. Essa é uma hipótese clássica da literatura econômica, que se baseia na ideia de que um povo vive melhor e por mais tempo, quando ele possui uma maior capacidade de adquirir bens e serviços. Tal modelo econométrico está apresentado abaixo, onde <span class="math inline">\(lifeExp_j\)</span> representa a expectativa de vida estimada para o país <span class="math inline">\(j\)</span>, e <span class="math inline">\(gdpPercap_j\)</span>, o PIB per capita observado para o mesmo país <span class="math inline">\(j\)</span>.</p>
<p><span class="math display">\[
lifeExp_j= \beta_{0} + \beta_{1} \times gdpPercap_j
\]</span></p>
<p>Caso você nunca tenha visto ou estudado sobre econometria (também conhecida como “análise de regressão linear”), não se preocupe em entender exatamente como o modelo é calculado, ou o que a equação acima representa. Se preocupe apenas em entender os seguintes pontos: 1) a função <code>lm()</code> é uma função presente nos pacotes básicos do R, que é capaz de calcular esse tipo de modelo; 2) precisamos aplicar essa função <code>lm()</code> sobre os dados de cada país, para obtermos os resultados do modelo separados para cada país.</p>
<p>Como um primeiro exemplo, para aplicarmos esse modelo econométrico sobre os dados de um país em específico, como o Brasil, poderíamos fazer o seguinte:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>br <span class="ot">&lt;-</span> gapminder <span class="sc">%&gt;%</span> </span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(country <span class="sc">==</span> <span class="st">"Brazil"</span>)</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>modelo <span class="ot">&lt;-</span> <span class="fu">lm</span>(lifeExp <span class="sc">~</span> gdpPercap, <span class="at">data =</span> br)</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(modelo)</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = lifeExp ~ gdpPercap, data = br)

Residuals:
   Min     1Q Median     3Q    Max 
-3.066 -1.278  0.367  1.335  2.350 

Coefficients:
             Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept) 4.599e+01  1.510e+00   30.46 3.41e-11 ***
gdpPercap   2.787e-03  2.405e-04   11.59 4.04e-07 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 1.943 on 10 degrees of freedom
Multiple R-squared:  0.9307,    Adjusted R-squared:  0.9238 
F-statistic: 134.4 on 1 and 10 DF,  p-value: 4.045e-07</code></pre>
</div>
</div>
<p>Portanto, no exemplo acima, o objeto <code>modelo</code> contém os resultados do modelo para o Brasil. Pois aplicamos a função <code>lm()</code> especificamente sobre os dados do Brasil. Todavia, caso aplicássemos a função <code>lm()</code> diretamente sobre a tabela <code>gapminder</code> inteira, teríamos na verdade, os resultados do modelo para todo o mundo (sem distinção de países). Pois estamos utilizando os dados de todos os países ao mesmo tempo para calcular o modelo.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="do">### Abaixo temos os resultados do modelo para</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="do">### todo o mundo. Pois aplicamos a função lm() sobre</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="do">### os dados de todos os países de uma vez só.</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>modelo <span class="ot">&lt;-</span> <span class="fu">lm</span>(lifeExp <span class="sc">~</span> gdpPercap, <span class="at">data =</span> gapminder)</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(modelo)</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = lifeExp ~ gdpPercap, data = gapminder)

Residuals:
    Min      1Q  Median      3Q     Max 
-82.754  -7.758   2.176   8.225  18.426 

Coefficients:
             Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept) 5.396e+01  3.150e-01  171.29   &lt;2e-16 ***
gdpPercap   7.649e-04  2.579e-05   29.66   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 10.49 on 1702 degrees of freedom
Multiple R-squared:  0.3407,    Adjusted R-squared:  0.3403 
F-statistic: 879.6 on 1 and 1702 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
</div>
<p>Agora, como poderíamos calcular os resultados desse modelo separados para cada um dos 142 países descritos em <code>gapminder</code>? Com a ajuda das funções <code>map</code>, replicar esse modelo para os 142 países, se torna uma tarefa extremamente simples de ser feita.</p>
<p>Pelo fato da função <code>map()</code> aplicar uma determinada função sobre cada elemento de um objeto, podemos utilizar <code>map()</code> para aplicarmos <code>lm()</code> sobre os dados de cada país. Sendo assim, cada elemento do objeto utilizado por <code>map()</code>, deve conter os dados de um país específico. Logo, cada elemento deste objeto seria muito provavelmente um <code>data.frame</code> contendo os dados de um país.</p>
<p>Dito de outra forma, vamos aplicar a função <code>map()</code> sobre uma lista de <code>data.frame</code>’s. Por esse motivo, a função que <code>map()</code> vai aplicar sobre cada elemento dessa lista, deve aceitar como <em>input</em>, um <code>data.frame</code> contendo os dados de um país específico, e gerar como <em>output</em>, os resultados do modelo aplicado sobre esses dados de <em>input</em>. Como primeiro passo, vamos criar essa função.</p>
<section id="a-função-que-calcula-o-modelo-econométrico" class="level3" data-number="16.3.1">
<h3 data-number="16.3.1" class="anchored" data-anchor-id="a-função-que-calcula-o-modelo-econométrico"><span class="header-section-number">16.3.1</span> A função que calcula o modelo econométrico</h3>
<p>Portanto, precisamos criar uma função que aceita um <code>data.frame</code> como <em>input</em>, e que calcula o modelo econométrico sobre os dados desse <em>input</em>. A função <code>aplicar_modelo()</code> abaixo, cumpre justamente esse papel. Tudo que essa função faz é aplicar a função <code>lm()</code> sobre o <code>data.frame</code> de <em>input</em> (argumento <code>x</code>). Perceba também que, independente de qual for o <code>data.frame</code> que fornecermos a essa função, ela vai sempre calcular o mesmo modelo, pois a equação na função <code>lm()</code> sempre será <code>lifeExp ~ gdpPercap</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>aplicar_modelo <span class="ot">&lt;-</span> <span class="cf">function</span>(x){</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lm</span>(lifeExp <span class="sc">~</span> gdpPercap, <span class="at">data =</span> x)</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="criando-uma-lista-de-data.frames" class="level3" data-number="16.3.2">
<h3 data-number="16.3.2" class="anchored" data-anchor-id="criando-uma-lista-de-data.frames"><span class="header-section-number">16.3.2</span> Criando uma lista de <code>data.frame</code>’s</h3>
<p>Podemos criar a lista de <code>data.frame</code>’s, contendo os dados de cada país, de diversas formas. Em sua palestra, Hadley Wickham utilizou a função <code>nest()</code>, proveniente do pacote <code>tidyr</code>, para criar essa lista de <code>data.frame</code>’s dentro de uma coluna do <code>data.frame</code> original. Ou seja, Wickham utilizou <code>nest()</code> para criar uma espécie de <code>data.frame</code> de <code>data.frame</code>’s, pois ele queria demonstrar esta poderosa ideia de um <em>nested</em> <code>data.frame</code>. Porém, como uma solução ainda mais simples, também poderíamos utilizar a função <code>split()</code> para dividirmos a tabela <code>gapminder</code> em uma lista, onde cada elemento dessa lista conteria um <code>data.frame</code> com os dados de um país diferente. Ambas as soluções são perfeitamente válidas.</p>
</section>
<section id="com-a-função-split" class="level3" data-number="16.3.3">
<h3 data-number="16.3.3" class="anchored" data-anchor-id="com-a-função-split"><span class="header-section-number">16.3.3</span> Com a função <code>split()</code></h3>
<p>Precisamos separar em diferentes elementos, os dados de cada país descrito na tabela <code>gapminder</code>. Para isso, podemos utilizar a função <code>split()</code>. Em resumo, essa função aceita um vetor ou <code>data.frame</code> como <em>input</em>, e divide esse objeto de <em>input</em> em diferentes elementos de uma lista, com base em algum vetor de grupos.</p>
<p>Logo, podemos pedir à <code>split()</code> que divida a tabela <code>gapminder</code> de acordo com os valores da coluna <code>country</code>. Veja o resultado abaixo:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>dados_por_pais <span class="ot">&lt;-</span> gapminder <span class="sc">%&gt;%</span> <span class="fu">split</span>(<span class="sc">~</span>country)</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>dados_por_pais[[<span class="dv">1</span>]]</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 12 × 6
  country     continent  year lifeExp      pop gdpPercap
  &lt;fct&gt;       &lt;fct&gt;     &lt;int&gt;   &lt;dbl&gt;    &lt;int&gt;     &lt;dbl&gt;
1 Afghanistan Asia       1952    28.8  8425333      779.
2 Afghanistan Asia       1957    30.3  9240934      821.
3 Afghanistan Asia       1962    32.0 10267083      853.
4 Afghanistan Asia       1967    34.0 11537966      836.
5 Afghanistan Asia       1972    36.1 13079460      740.
# ℹ 7 more rows</code></pre>
</div>
</div>
<p>Portanto, o objeto <code>dados_por_pais</code> é uma lista, onde cada elemento dessa lista, contém um <code>data.frame</code> com os dados de um país específico. Agora, podemos utilizar a função <code>map()</code> para simplesmente aplicarmos a função <code>aplicar_modelo()</code> sobre cada elemento dessa lista, ou, sobre os dados de cada país. Como resultado, teremos uma nova lista, onde cada elemento dessa lista, contém os resultados do modelo para um determinado país. No exemplo abaixo, estou mostrando os resultados do modelo para o Afeganistão. Curiosamente, o coeficiente estimado pelo modelo foi negativo (-0,00224), indicando assim, que para o Afeganistão, aumentos no PIB per capita reduzem a expectativa de vida estimada da população. Um resultado que contradiz a nossa hipótese inicial.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>modelos <span class="ot">&lt;-</span> <span class="fu">map</span>(dados_por_pais, aplicar_modelo)</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(modelos[[<span class="dv">1</span>]])</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = lifeExp ~ gdpPercap, data = x)

Residuals:
   Min     1Q Median     3Q    Max 
-8.730 -3.880  1.845  3.866  6.734 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)   
(Intercept) 39.27720   12.04623   3.261  0.00857 **
gdpPercap   -0.00224    0.01488  -0.151  0.88334   
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 5.341 on 10 degrees of freedom
Multiple R-squared:  0.002261,  Adjusted R-squared:  -0.09751 
F-statistic: 0.02266 on 1 and 10 DF,  p-value: 0.8833</code></pre>
</div>
</div>
<p>Com a lista <code>modelos</code>, podemos continuar utilizando a função <code>map()</code> para extrair informações específicas desses modelos. Por exemplo, os comandos abaixo utilizam a função <code>glance()</code> do pacote <code>broom</code> para extrair o <span class="math inline">\(R^2\)</span> (coeficiente de determinação) estimado por cada modelo. No exemplo abaixo, estou mostrando os coeficientes dos 10 primeiros países.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>r2s <span class="ot">&lt;-</span> modelos <span class="sc">%&gt;%</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(broom<span class="sc">::</span>glance) <span class="sc">%&gt;%</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map_dbl</span>(<span class="st">"r.squared"</span>)</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>r2s[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>]</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Afghanistan     Albania     Algeria      Angola   Argentina   Australia 
0.002260718 0.700762689 0.818067786 0.090648834 0.691638237 0.973075112 
    Austria     Bahrain  Bangladesh     Belgium 
0.985977854 0.806033051 0.717947961 0.985551840 </code></pre>
</div>
</div>
</section>
<section id="com-a-função-nest" class="level3" data-number="16.3.4">
<h3 data-number="16.3.4" class="anchored" data-anchor-id="com-a-função-nest"><span class="header-section-number">16.3.4</span> Com a função <code>nest()</code></h3>
<p>Apesar da função <code>split()</code> já nos oferecer uma ótima solução, também podemos muito bem adotar a solução mostrada por Wickham, que utiliza a função <code>nest()</code> para criar um “<code>data.frame</code> de <code>data.frame</code>’s”.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-nest" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-nest-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./../Figuras/nest.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-nest-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figura&nbsp;16.4: Transformação executada por <code>nest()</code>
</figcaption>
</figure>
</div>
</div>
</div>
<p>No momento, cada linha da tabela <code>gapminder</code> descreve os dados de um país em um determinado ano. Entretanto, a nossa intenção com essa solução, é transformar a tabela <code>gapminder</code>, de modo que cada linha da tabela contenha todos os dados de um determinado país para todos os anos.</p>
<p>Podemos realizar essa transformação, ao agruparmos à tabela pela coluna <code>country</code> (com a função <code>group_by()</code>) e, em seguida, aplicarmos a função <code>nest()</code> do pacote <code>tidyr</code>, como demonstrado abaixo:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(magrittr)</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>dados_por_pais <span class="ot">&lt;-</span> gapminder <span class="sc">%&gt;%</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(country, continent) <span class="sc">%&gt;%</span> </span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest</span>()</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>dados_por_pais</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 142 × 3
# Groups:   country, continent [142]
  country     continent data             
  &lt;fct&gt;       &lt;fct&gt;     &lt;list&gt;           
1 Afghanistan Asia      &lt;tibble [12 × 4]&gt;
2 Albania     Europe    &lt;tibble [12 × 4]&gt;
3 Algeria     Africa    &lt;tibble [12 × 4]&gt;
4 Angola      Africa    &lt;tibble [12 × 4]&gt;
5 Argentina   Americas  &lt;tibble [12 × 4]&gt;
# ℹ 137 more rows</code></pre>
</div>
</div>
<p>Dessa vez, o objeto <code>dados_por_pais</code> é um <code>data.frame</code> que contém três colunas (<code>country</code>, <code>continent</code> e <code>data</code>). A coluna <code>data</code> é uma lista, e cada elemento dessa lista contém um novo <code>data.frame</code>, que por sua vez, contém todos os dados referentes ao país identificado na coluna <code>country</code> da tabela.</p>
<p>Ou seja, ainda estamos utilizando uma lista de <code>data.frame</code>’s, onde cada <code>data.frame</code> dessa lista contém os dados de um país específico. A diferença agora, é que essa lista está inserida em uma coluna de um <code>data.frame</code>, ao invés de estar em um objeto separado.</p>
<p>Portanto, a <a href="#fig-nest" class="quarto-xref">Figura&nbsp;<span>16.4</span></a> apresenta de forma gráfica a transformação executada por <code>nest()</code>. Repare também, que o pacote <code>tidyr</code> nos oferece a função <code>unnest()</code>, com a qual podemos reverter a transformação executada por <code>nest()</code>.</p>
<p>Como exemplo, os dados do Brasil estão na 15° linha da tabela <code>dados_por_pais</code>. Logo, eu posso adquirir todos os dados do Brasil, ao acessar o 15° elemento da coluna <code>data</code>. Perceba abaixo, que um novo <code>data.frame</code> é retornado, que contém todos os dados referentes ao Brasil.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>dados_por_pais<span class="sc">$</span>data[[<span class="dv">15</span>]]</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 12 × 4
   year lifeExp       pop gdpPercap
  &lt;int&gt;   &lt;dbl&gt;     &lt;int&gt;     &lt;dbl&gt;
1  1952    50.9  56602560     2109.
2  1957    53.3  65551171     2487.
3  1962    55.7  76039390     3337.
4  1967    57.6  88049823     3430.
5  1972    59.5 100840058     4986.
# ℹ 7 more rows</code></pre>
</div>
</div>
<p>Agora, precisamos apenas aplicar a função <code>aplicar_modelo()</code> sobre cada elemento da coluna <code>data</code>. Para isso, podemos utilizar novamente a função <code>map()</code>, dessa vez, dentro da função <code>mutate()</code> que introduzimos no capítulo 4. Dessa maneira, <code>map()</code> vai executar a função <code>aplicar_modelo()</code> para cada elemento da coluna <code>data</code>, e retornar uma lista com os resultados, e a função <code>mutate()</code> vai adicionar essa lista como uma nova coluna do <code>data.frame</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>modelos <span class="ot">&lt;-</span> dados_por_pais <span class="sc">%&gt;%</span> </span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">resultados =</span> data <span class="sc">%&gt;%</span> <span class="fu">map</span>(aplicar_modelo)</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>modelos</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 142 × 4
# Groups:   country, continent [142]
  country     continent data              resultados
  &lt;fct&gt;       &lt;fct&gt;     &lt;list&gt;            &lt;list&gt;    
1 Afghanistan Asia      &lt;tibble [12 × 4]&gt; &lt;lm&gt;      
2 Albania     Europe    &lt;tibble [12 × 4]&gt; &lt;lm&gt;      
3 Algeria     Africa    &lt;tibble [12 × 4]&gt; &lt;lm&gt;      
4 Angola      Africa    &lt;tibble [12 × 4]&gt; &lt;lm&gt;      
5 Argentina   Americas  &lt;tibble [12 × 4]&gt; &lt;lm&gt;      
# ℹ 137 more rows</code></pre>
</div>
</div>
<p>Agora, cada elemento da coluna <code>resultados</code> contém todos os resultados do modelo para cada país da tabela <code>gapminder</code>. A partir daqui, podemos utilizar novamente as funções <code>map</code> para extrairmos as informações específicas dos modelos. Por exemplo, podemos extrair o beta estimado (<span class="math inline">\(\beta_1\)</span>) e o coeficiente de determinação de cada país, e adicioná-los como novas colunas da tabela modelos.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>modelos <span class="ot">&lt;-</span> modelos <span class="sc">%&gt;%</span> </span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">glance =</span> resultados <span class="sc">%&gt;%</span> <span class="fu">map</span>(broom<span class="sc">::</span>glance),</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">tidy =</span> resultados <span class="sc">%&gt;%</span> <span class="fu">map</span>(broom<span class="sc">::</span>tidy),</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">beta_estimado =</span> tidy <span class="sc">%&gt;%</span> <span class="fu">map_dbl</span>(<span class="sc">~</span>.[[<span class="st">"estimate"</span>]][<span class="dv">2</span>]),</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">r2 =</span> glance <span class="sc">%&gt;%</span> <span class="fu">map_dbl</span>(<span class="st">"r.squared"</span>)</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>glance, <span class="sc">-</span>tidy)</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>modelos</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 142 × 6
# Groups:   country, continent [142]
  country     continent data              resultados beta_estimado      r2
  &lt;fct&gt;       &lt;fct&gt;     &lt;list&gt;            &lt;list&gt;             &lt;dbl&gt;   &lt;dbl&gt;
1 Afghanistan Asia      &lt;tibble [12 × 4]&gt; &lt;lm&gt;            -0.00224 0.00226
2 Albania     Europe    &lt;tibble [12 × 4]&gt; &lt;lm&gt;             0.00444 0.701  
3 Algeria     Africa    &lt;tibble [12 × 4]&gt; &lt;lm&gt;             0.00714 0.818  
4 Angola      Africa    &lt;tibble [12 × 4]&gt; &lt;lm&gt;            -0.00103 0.0906 
5 Argentina   Americas  &lt;tibble [12 × 4]&gt; &lt;lm&gt;             0.00187 0.692  
# ℹ 137 more rows</code></pre>
</div>
</div>
<p>Com esses resultados em mãos, podemos criar visualizações muito interessantes. Como o gráfico de dispersão abaixo, que apresenta a relação entre o beta estimado e o coeficiente de determinação do modelo. Repare nesse gráfico, que os países da Europa, em geral, possuem um beta estimado baixo, indicando assim, que aumentos no PIB per capita tem baixos impactos na expectativa de vida. Isso provavelmente ocorre, porque esses países já possuem expectativas de vida relativamente altas.</p>
<p>Por outro lado, perceba também que os países africanos parecem se concentrar nos dois extremos do gráfico, com os maiores e menores betas estimados. Os maiores betas, indicam que aumentos no PIB per capita trazem fortes impactos positivos sobre as expectativas de vida nesses países. Isso provavelmente se deve à vida precária e a baixa expectativa de vida que a população desses países enfrenta, de modo que, uma melhoria mínima pode trazer grandes impactos positivos nas condições de vida dessas populações.</p>
<p>Para mais, repare que os países africanos que possuem betas estimados negativos também possuem coeficientes de determinação baixos, indicando assim, um baixo poder explicativo do modelo. Isso é um sinal de que o nosso modelo não consegue explicar muito dos dados desses países, e provavelmente, esse baixo poder explicativo gerou um beta estimado negativo, que é algo inesperado para essa relação entre expectativa de vida e renda per capita.</p>
<p>Talvez, esses países tem características importantes que os outros países não possuem, e que afetam essa relação econômica. Por exemplo, muitos países africanos enfrentam guerras civis recorrentes. Guerras desse tipo geram impactos negativos na expectativa de vida, e as mortes podem gerar quedas na população total do país, o que resultaria em um aumento do PIB per capita (<em>ceteris paribus</em>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>modelos <span class="sc">%&gt;%</span> </span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> r2, <span class="at">y =</span> beta_estimado, <span class="at">color =</span> continent)</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="18-purrr_files/figure-html/unnamed-chunk-30-1.png" class="img-fluid figure-img" style="width:60.0%"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="comparando-a-família-map-à-família-apply" class="level2" data-number="16.4">
<h2 data-number="16.4" class="anchored" data-anchor-id="comparando-a-família-map-à-família-apply"><span class="header-section-number">16.4</span> Comparando a família <code>map</code> à família <code>apply</code></h2>
<p>Os pacotes básicos do R, nos oferecem a família <code>apply</code> de funções, a qual desenvolve um papel muito similar às funções <code>map</code>. Os membros dessa família estão listados abaixo:</p>
<ul>
<li><code>apply</code> (<em>generic apply</em>): retorna diferentes tipos de estrutura a depender de um conjunto de condições.</li>
<li><code>lapply</code> (<em>list apply</em>): retorna uma lista.</li>
<li><code>sapply</code> (<em>simple apply</em>): tenta simplificar o resultado para uma estrutura mais “simples”, a depender do comprimento de cada resultado gerado por <code>FUN</code>.</li>
<li><code>vapply</code> (<em>vector apply</em>): retorna um vetor de mesmo tipo de dado que o vetor definido no argumento <code>FUN.VALUE</code>.</li>
</ul>
<p>Tendo isso em mente, todas essas funções aceitam um objeto (<code>X</code>) e uma função (<code>FUN</code>) em seus dois primeiros argumentos. Essas funções <code>apply</code> vão aplicar a função <code>FUN</code> sobre cada elemento do objeto <code>X</code> fornecido, e retornar como resultado, um novo objeto contendo todos os resultados gerados pela função <code>FUN</code> aplicada sobre cada elemento do objeto <code>X</code>.</p>
<p>Um dos principais motivos pelos quais a família <code>apply</code> tem perdido espaço para a família <code>map</code>, é pelo fato dessas funções serem menos consistentes, especialmente quanto à estrutura do resultado retornado. Por exemplo, <code>apply()</code> pode retornar um vetor, um <code>array</code> ou uma lista como resultado. Para mais, as condições que determinam qual dessas estruturas é retornada por <code>apply()</code> são levemente confusas. Se estiver curioso, leia a seção <code>Value</code> da documentação interna (<code>?apply</code>).</p>
<p>A função <code>sapply()</code> também é um outro caso de incosistência, pois essa função altera a estrutura de dados retornada, a depender do comprimento de cada um dos resultados gerados pela função <code>FUN</code>. Isso significa que, a estrutura de dados retornada por <code>sapply()</code> é determinada por um conjunto de resultados aos quais nós não temos acesso enquanto a função não completar a sua execução. Ou seja, nós não somos capazes de prever com antecedência, qual será a estrutura retornada por <code>sapply()</code>. Isso é um problema grave, dado que ele pode gerar bugs em seu script com muita facilidade, caso você não esteja preparado para lidar com literalmente qualquer tipo de resultado possível de <code>sapply()</code>.</p>
<p>São inconsistências desse tipo, que tornaram as funções <code>map</code> o padrão utilizado pela comunidade na construção de muitos pacotes e funções. Pois as funções <code>map</code> são extremamente consistentes em seus resultados. Por esse mesmo motivo, que as funções <code>lapply()</code> e <code>vapply()</code> são exemplos de funções <code>apply</code> que ainda são muito utilizadas em diversos pacotes e funções existentes na atualidade.</p>
<p>Pois diferente de <code>apply()</code> e <code>sapply()</code>, essas funções são consistentes em seus resultados. A função <code>lapply()</code> é equivalente à função <code>map()</code>, pois ela sempre lhe retorna uma lista como resultado. Já a função <code>vapply()</code> vai sempre retornar um vetor de mesmo tipo de dado que o vetor fornecido ao seu argumento <code>FUN.VALUE</code>. Ou seja, poderíamos reproduzir a função <code>map_dbl()</code> com <code>vapply()</code>, ao fornecermos um vetor do tipo <code>double</code> ao seu argumento <code>FUN.VALUE</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>numeros <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="fl">1.5</span>, <span class="fl">2.5</span>, <span class="dv">3</span>),</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="fl">9.8</span>, <span class="fl">1.2</span>),</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="fl">1.2</span>, <span class="fl">1.3</span>, <span class="fl">1.5</span>, <span class="fl">1.1</span>)</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>somas <span class="ot">&lt;-</span> <span class="fu">vapply</span>(numeros, <span class="at">FUN =</span> sum, <span class="at">FUN.VALUE =</span> <span class="fu">double</span>(<span class="dv">1</span>))</span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(somas)</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1]  7.0 11.0  5.1</code></pre>
</div>
</div>
<p>Na verdade, a função <code>vapply()</code> também é capaz de retornar matrizes e arrays. Tudo depende de como você organiza o objeto fornecido ao argumento <code>FUN.VALUE</code>. Isso é um diferencial importante, que nenhuma das funções <code>map</code> são capazes de fazer até o momento.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="do">### Retorna uma matriz</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="fu">vapply</span>(numeros, <span class="at">FUN =</span> range, <span class="at">FUN.VALUE =</span> <span class="fu">double</span>(<span class="dv">2</span>))</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     [,1] [,2] [,3]
[1,]  1.5  1.2  1.1
[2,]  3.0  9.8  1.5</code></pre>
</div>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="do">### Retorna um array</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="fu">vapply</span>(numeros, <span class="at">FUN =</span> range, <span class="at">FUN.VALUE =</span> <span class="fu">array</span>(<span class="fu">double</span>(<span class="dv">1</span>), <span class="at">dim =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">1</span>)))</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>, , 1, 1

     [,1] [,2]
[1,]  1.5    3

, , 1, 2

     [,1] [,2]
[1,]  1.2  9.8

, , 1, 3

     [,1] [,2]
[1,]  1.1  1.5</code></pre>
</div>
</div>
</section>
<section id="identificando-erros-nas-funções-map" class="level2" data-number="16.5">
<h2 data-number="16.5" class="anchored" data-anchor-id="identificando-erros-nas-funções-map"><span class="header-section-number">16.5</span> Identificando erros nas funções <code>map</code></h2>
<p>A cada iteração do loop criado por <code>map</code>, estamos executando a função definida no argumento <code>.f</code>. Isso significa que, em um loop de 10 mil iterações, essa função será chamada 10 mil vezes. Isso é um detalhe importante, pois um erro pode surgir em cada uma dessas 10 mil chamadas. E caso esse erro ocorra, como você faria para identificar a sua fonte? É esse tema que vamos abordar nessa seção.</p>
<p>Vamos utilizar os comandos abaixo como exemplo. Perceba que um erro foi levantado.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>valores <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>  <span class="fl">2.5</span>, <span class="fl">5.1</span>, <span class="fl">6.7</span>, <span class="fl">8.9</span>, <span class="st">"9.1"</span>, <span class="fl">0.2</span>,</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"4.4"</span>, <span class="st">"5.1"</span>, <span class="st">"7.4"</span>, <span class="fl">3.6</span>, <span class="fl">3.8</span>,</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>  <span class="fl">4.2</span>, <span class="fl">8.7</span>, <span class="fl">8.8</span></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>logaritmos <span class="ot">&lt;-</span> valores <span class="sc">%&gt;%</span> <span class="fu">map_dbl</span>(log)</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<pre><code>Error in .Primitive("log")(x, base) :
  non-numeric argument to mathematical function</code></pre>
<p>A principal dificuldade que temos é identificar <strong>onde</strong> o erro ocorreu. Isto é, em qual das iterações esse erro ocorreu? Será que ele ocorre logo na primeira iteração do loop? Ou, talvez na última iteração? Ou ainda, ao longo de várias iterações diferentes do loop?</p>
<p>Para identificar tais pontos, poderíamos ter acesso aos resultados que foram gerados com sucesso, e aos resultados que fracassaram. Para isso, o pacote <code>purrr</code> nos provê a função <code>safely()</code>.</p>
<p>Você deve aplicar essa função <code>safely()</code> sobre a função <code>.f</code> que você deseja utilizar dentro de <code>map()</code>. Como resultado, <code>safely()</code> gera uma nova versão da função <code>.f</code>, que é capaz de coletar os todos os resultados gerados, mesmo que eles levantem algum erro durante sua execução.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>safe_log <span class="ot">&lt;-</span> <span class="fu">safely</span>(log)</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>safe_log</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>function (...) 
capture_error(.f(...), otherwise, quiet)
&lt;bytecode: 0x563e229639b0&gt;
&lt;environment: 0x563e22963e48&gt;</code></pre>
</div>
</div>
<p>O que essa nova versão da função faz, é sempre gerar uma lista com dois elementos (<code>result</code> e <code>error</code>) para cada <em>input</em>. O elemento <code>result</code> vai estar preenchido com o resultado da função caso ele tenha sido gerado com sucesso, enquanto o elemento <code>error</code>, estará vazio. Entretanto, caso algum erro ocorra e o resultado da função não possa ser gerado, o contrário ocorre. Ou seja, o elemento <code>result</code> estará vazio, enquanto o elemento <code>error</code> irá conter o erro que interrompeu a execução.</p>
<p>No primeiro exemplo abaixo, o elemento <code>result</code> gerado por <code>safe_log()</code> contém o valor <code>2.302585</code>, que corresponde ao resultado de <code>log(10)</code>. Isso significa que o valor da expressão <code>log(10)</code> pôde ser calculado com sucesso, sem nenhum erro encontrado. Porém, no segundo exemplo abaixo, o elemento <code>result</code> está vazio, enquanto o elemento <code>error</code> contém a mensagem de erro gerada. Logo, o resultado da expressão <code>log("a")</code> não pôde ser calculada com sucesso, pois o erro contido no elemento <code>error</code> foi levantado durante a execução.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="fu">safe_log</span>(<span class="dv">10</span>) <span class="sc">%&gt;%</span> <span class="fu">str</span>()</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 2
 $ result: num 2.3
 $ error : NULL</code></pre>
</div>
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="fu">safe_log</span>(<span class="st">"a"</span>) <span class="sc">%&gt;%</span> <span class="fu">str</span>()</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 2
 $ result: NULL
 $ error :List of 2
  ..$ message: chr "non-numeric argument to mathematical function"
  ..$ call   : language .Primitive("log")(x, base)
  ..- attr(*, "class")= chr [1:3] "simpleError" "error" "condition"</code></pre>
</div>
</div>
<p>Agora, podemos simplesmente fornecer para <code>map()</code> a nova função criada. Repare que dessa vez, eu estou utilizando a função <code>map()</code> ao invés da função <code>map_dbl()</code> para coletar os resultados gerados por <code>safe_log()</code>. Pois a função <code>log()</code> gera um único valor do tipo <code>double</code> para cada <em>input</em>, já a função <code>safe_log()</code>, gera uma lista com dois elementos (<code>result</code> e <code>error</code>) para cada <em>input</em>. Como exemplo, mostro abaixo os resultados para os 3 primeiros elementos. Perceba que nenhum desses elementos levantou algum erro, dado que o elemento <code>error</code> está vazio para todos eles.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>logaritmos <span class="ot">&lt;-</span> valores <span class="sc">%&gt;%</span> <span class="fu">map</span>(safe_log)</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>logaritmos[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>] <span class="sc">%&gt;%</span> </span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">str</span>()</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 3
 $ :List of 2
  ..$ result: num 0.916
  ..$ error : NULL
 $ :List of 2
  ..$ result: num 1.63
  ..$ error : NULL
 $ :List of 2
  ..$ result: num 1.9
  ..$ error : NULL</code></pre>
</div>
</div>
<p>Sendo assim, para identificarmos quais elementos de <code>valores</code> são os responsáveis por levantar o erro que vimos anteriormente, podemos navegar por cada elemento de <code>logaritmos</code>, e descobrir em quais deles, o elemento <code>error</code> não está vazio.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>erros <span class="ot">&lt;-</span> logaritmos <span class="sc">%&gt;%</span> <span class="fu">map</span>(<span class="st">"error"</span>)</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>erro_nao_vazio <span class="ot">&lt;-</span> erros <span class="sc">%&gt;%</span> <span class="fu">map_lgl</span>(<span class="sc">~!</span><span class="fu">is.null</span>(.))</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>valores[erro_nao_vazio] <span class="sc">%&gt;%</span> </span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">str</span>()</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 4
 $ : chr "9.1"
 $ : chr "4.4"
 $ : chr "5.1"
 $ : chr "7.4"</code></pre>
</div>
</div>
<p>Repare acima, que antes de aplicar o teste lógico para saber quais erros estavam vazios, eu precisei extrair primeiro o elemento <code>error</code> de todos os elementos de <code>logaritmos</code>. Como uma alternativa, podemos reorganizar os elementos de <code>logaritmos</code> em duas listas diferentes, uma contendo todos os resultados gerados (<code>result</code>), e outra, contendo todos os erros gerados (<code>error</code>).</p>
<p>Para isso, basta aplicarmos a função <code>transpose()</code> sobre o objeto <code>logaritmos</code>. Agora, o objeto <code>logaritmos</code> contém dentro dele, uma lista de resultados (<code>result</code>) e uma lista de erros (<code>error</code>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>logaritmos <span class="ot">&lt;-</span> <span class="fu">transpose</span>(logaritmos)</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>logaritmos<span class="sc">$</span>result[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>]</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
[1] 0.9162907

[[2]]
[1] 1.629241

[[3]]
[1] 1.902108</code></pre>
</div>
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>logaritmos<span class="sc">$</span>error[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>]</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
NULL

[[2]]
NULL

[[3]]
NULL</code></pre>
</div>
</div>
<p>Com essa estrutura, podemos reproduzir o teste anterior com:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>erro_nao_vazio <span class="ot">&lt;-</span> <span class="fu">map_lgl</span>(logaritmos<span class="sc">$</span>error, <span class="sc">~!</span><span class="fu">is.null</span>(.))</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>valores[erro_nao_vazio] <span class="sc">%&gt;%</span> </span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">str</span>()</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 4
 $ : chr "9.1"
 $ : chr "4.4"
 $ : chr "5.1"
 $ : chr "7.4"</code></pre>
</div>
</div>
<p>Portanto, sabemos agora que os elementos <code>"9.1"</code>, <code>"4.4"</code>, <code>"5.1"</code> e <code>"7.4"</code> do objeto <code>valores</code> estão levantando erros quando aplicamos a função <code>log()</code> sobre eles. Com isso, podemos reproduzir o erro ao aplicar a função <code>log()</code> sobre um desses elementos. Dessa forma, podemos analisar caso a caso de forma mais concentrada, e entender o que está gerando o erro.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="fu">log</span>(<span class="st">"9.1"</span>)</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<pre><code>Error in log("9.1") : non-numeric argument to mathematical function</code></pre>
<p>De qualquer forma, você provavelmente já entendeu qual é o problema. Esses elementos estão sendo interpretados pelo tipo <code>character</code>, ao invés de um tipo numérico como o tipo <code>double</code>. Em outras palavras, a função <code>log()</code> não sabe como calcular o logaritmo de um valor textual (ou uma <em>string</em>), como <code>"9.1"</code>.</p>
<p>Tendo isso em mente, poderíamos aplicar a função <code>as.double()</code> sobre esses elementos para resolvermos esse problema. Perceba que após realizarmos essa correção, o comando com <code>map_dbl()</code> executa normalmente sem nenhum erro.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>valores[erro_nao_vazio] <span class="ot">&lt;-</span> valores[erro_nao_vazio] <span class="sc">%&gt;%</span> </span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(as.double)</span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a><span class="do">### Agora, os comandos abaixo funcionam normalmente</span></span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a><span class="do">### sem nenhum erro.</span></span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>logaritmos <span class="ot">&lt;-</span> valores <span class="sc">%&gt;%</span> <span class="fu">map_dbl</span>(log)</span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a>logaritmos </span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1]  0.9162907  1.6292405  1.9021075  2.1860513  2.2082744 -1.6094379
 [7]  1.4816045  1.6292405  2.0014800  1.2809338  1.3350011  1.4350845
[13]  2.1633230  2.1747517</code></pre>
</div>
</div>
<p>Portanto, a função <code>safely()</code> te oferece um conjunto de informações mais completas sobre cada execução, pois ela te traz exatamente qual foi a mensagem de erro retornada. Porém, em algumas ocasiões, você só quer coletar os resultados gerados.</p>
<p>Para isso, temos uma outra função irmã mais simplificada, que é a função <code>possibly()</code>. Assim como ocorre com <code>safely()</code>, essa função <code>possibly()</code> recebe uma outra função como <em>input</em>, e retorna como <em>output</em>, uma nova versão da função de <em>input</em>. Assim como ocorre com <code>safely()</code>, a função criada por <code>possibly()</code> vai sempre executar com sucesso, mesmo que um erro seja levantado pela função principal <code>.f</code>.</p>
<p>Para mais, a função <code>possibly()</code> te permite definir um valor padrão de retorno, caso a execução da função principal <code>.f</code> retorne um erro. Por exemplo, com os comandos abaixo, estou definindo que se a função <code>log()</code> levantar algum erro para um determinado <em>input</em>, ela deve retornar como <em>output</em> o valor <code>NA_real_</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>valores <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>  <span class="fl">3.2</span>, <span class="fl">4.4</span>, <span class="fl">5.1</span>, <span class="fl">8.6</span>,</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"C"</span></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a>valores <span class="sc">%&gt;%</span> </span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map_dbl</span>(<span class="fu">possibly</span>(log, <span class="cn">NA_real_</span>))</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1.163151 1.481605 1.629241 2.151762       NA       NA       NA</code></pre>
</div>
</div>
<p>Apesar de duas opções bastante úteis, você pode ainda estar interessado em coletar outras informações sobre a execução de cada iteração. Como exemplo, a função <code>quietly()</code> exerce um papel semelhante à <code>safely()</code>, mas, ao invés de coletar erros, essa função busca coletar os resultados, mensagens e avisos gerados em cada iteração, além dos possíveis <em>outputs</em> que são mostrados na tela.</p>
<p>Perceba no exemplo abaixo, que assim como ocorre com <code>safely()</code> e <code>possibly()</code>, <code>quietly()</code> também nos retorna uma nova versão da função <code>print()</code>. Quando eu aplico essa nova função sobre algum <em>input</em> qualquer, é retornado uma lista com 4 elementos. Como os elementos <code>warnings</code> e <code>messages</code> abaixo estão vazios, isso significa que não houveram avisos ou mensagens acionadas durante a execução da expressão <code>print(8)</code>. Para mais, podemos ver através dos itens <code>result</code> e <code>output</code>, o resultado da expressão e, também, qual é o texto apresentado em nosso console quando a expressão <code>print(8)</code> é executada.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>quiet_print <span class="ot">&lt;-</span> <span class="fu">quietly</span>(print)</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a><span class="fu">quiet_print</span>(<span class="dv">8</span>)</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$result
[1] 8

$output
[1] "[1] 8"

$warnings
character(0)

$messages
character(0)</code></pre>
</div>
</div>
<p>Sendo assim, podemos utilizar a função <code>quietly()</code> em conjunto com <code>map()</code> para coletarmos essas informações sobre a execução de uma função qualquer sobre vários <em>inputs</em> diferentes. Veja no exemplo abaixo, que o segundo <em>input</em> da lista <code>x</code> (<code>-10</code>) gerou um aviso, pois o elemento <code>warnings</code> da segunda lista no resultado não está vazio.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="dv">5</span>, <span class="sc">-</span><span class="dv">10</span>, <span class="dv">15</span>)</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>x <span class="sc">%&gt;%</span></span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(<span class="fu">quietly</span>(log)) <span class="sc">%&gt;%</span> </span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">str</span>()</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 3
 $ :List of 4
  ..$ result  : num 1.61
  ..$ output  : chr ""
  ..$ warnings: chr(0) 
  ..$ messages: chr(0) 
 $ :List of 4
  ..$ result  : num NaN
  ..$ output  : chr ""
  ..$ warnings: chr "NaNs produced"
  ..$ messages: chr(0) 
 $ :List of 4
  ..$ result  : num 2.71
  ..$ output  : chr ""
  ..$ warnings: chr(0) 
  ..$ messages: chr(0) </code></pre>
</div>
</div>
</section>
<section id="compreendendo-as-funções-map_dfr-e-map_dfc" class="level2" data-number="16.6">
<h2 data-number="16.6" class="anchored" data-anchor-id="compreendendo-as-funções-map_dfr-e-map_dfc"><span class="header-section-number">16.6</span> Compreendendo as funções <code>map_dfr()</code> e <code>map_dfc()</code></h2>
<p>Novamente, as funções <code>map_dfc()</code> e <code>map_dfr()</code> realizam exatamente o mesmo trabalho e possuem os mesmos argumentos das demais funções <code>map</code>. Contudo, como você já deve ter pressuposto pelo sufixo <code>df</code>, as funções <code>map_dfc()</code> e <code>map_dfr()</code> retornam como resultado, um <code>data.frame</code>. Porém, essas duas funções constroem esse novo <code>data.frame</code> de maneiras distintas.</p>
<p>Em primeiro lugar, você pode utilizar as funções <code>map_dfr()</code> e <code>map_dfc()</code>, sempre que um <code>data.frame</code> é gerado a cada iteração do <em>loop</em> criado pela função <code>map</code>. Ou seja, quando aplicamos a função <code>.f</code> sobre um elemento de <code>.x</code>, um <code>data.frame</code> é gerado como resultado. Dito ainda de uma outra forma, a função <code>.f</code> recebe um elemento de <code>.x</code> como <em>input</em>, e gera um novo <code>data.frame</code> como <em>output</em>.</p>
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./../Figuras/map_dfr.png" class="img-fluid figure-img" style="width:80.0%"></p>
<figcaption><code>map_dfr()</code> une os <code>data.frame</code>’s gerados, por linha</figcaption>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./../Figuras/map_dfc.png" class="img-fluid figure-img" style="width:80.0%"></p>
<figcaption><code>map_dfc()</code> une os <code>data.frame</code>’s gerados, por coluna</figcaption>
</figure>
</div>
</div>
</div>
<p>Portanto, se você utiliza a função <code>map_df*()</code> sobre um objeto de 50 elementos, é esperado que 50 <code>data.frame</code>’s sejam gerados durante a execução de <code>map_df*()</code>. Após gerar todos esses 50 <code>data.frame</code>’s, a função <code>map_df*()</code> em questão, vai tentar uni-los em um único <code>data.frame</code>. Por fim, a função vai retornar como resultado, esse <code>data.frame</code> único, que contém os resultados de todos os 50 <code>data.frame</code>’s gerados.</p>
<p>Por isso, a única diferença essencial entre as funções <code>map_dfr()</code> e <code>map_dfc()</code>, está na forma como essas funções vão unir esses 50 <code>data.frame</code>’s gerados. Como você pode observar nas figuras 16.5 e 16.6, <code>map_dfr()</code> une os <code>data.frame</code>’s por linha, enquanto <code>map_dfc()</code>, une por coluna.</p>
<p>Tendo esses pontos em mente, as funções <code>map_dfr()</code> e <code>map_dfc()</code> são particularmente úteis, quando desejamos aplicar uma função sobre cada elemento de um objeto, e armazenar todos os resultados em um <code>data.frame</code> único.</p>
</section>
<section id="sec:demanda_dist_ICMS" class="level2" data-number="16.7">
<h2 data-number="16.7" class="anchored" data-anchor-id="sec:demanda_dist_ICMS"><span class="header-section-number">16.7</span> Um estudo de caso: uma demanda real sobre a distribuição de ICMS</h2>
<p>Nessa seção, vou apresentar um exemplo prático, sobre uma demanda real que chegou até mim em 2020. Na época, eu trabalhava como estagiário na Diretoria de Estatística e Informações da Fundação João Pinheiro (FJP-MG), mais especificamente com uma lei estadual que é tradicionalmente chamada de Lei Robin Hood (Lei 18.030 de 2009 - MG). Essa lei rege a distribuição do ICMS total de Minas Gerais, ao longo dos municípios do estado.</p>
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./../Figuras/planilhas1.png" class="img-fluid figure-img" style="width:80.0%"></p>
<figcaption>Lista de arquivos do Excel</figcaption>
</figure>
</div>
</div>
</div>
<p>Em resumo, o Governo de Minas Gerais, coleta o ICMS (imposto sobre operações relativas à circulação de mercadorias e sobre prestações de serviços de transporte interestadual, intermunicipal e de comunicação) gerado em todo o estado, e ao final de um período, ele redistribui esse valor para os 853 municípios do estado. Cada município, possui um índice de participação, que corresponde à porcentagem do ICMS total ao qual o respectivo município tem direito. Em outras palavras, se o ICMS total gerado no estado em um período foi de 8,5 bilhões de reais, e o município de Belo Horizonte possui um índice de participação equivalente a 0,009, isso significa que ao final do período, 0,9% do ICMS total, ou 76,5 milhões de reais serão transferidos para a prefeitura do município de Belo Horizonte.</p>
<p>Diversos critérios descritos na lei regem o cálculo deste índice de participação de cada município, sendo alguns deles: Turismo, Esporte, Patrimônio Cultural, População e Receita Própria. Em suma, o índice de participação de cada município, é uma média ponderada dos índices de cada um desses diversos critérios da lei. Você pode encontrar uma descrição completa desses critérios e do cálculo dos índices de participação, no texto original da lei<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>.</p>
<section id="a-demanda-em-si" class="level3" data-number="16.7.1">
<h3 data-number="16.7.1" class="anchored" data-anchor-id="a-demanda-em-si"><span class="header-section-number">16.7.1</span> A demanda em si</h3>
<p>A demanda é muito simples, porém, ela é trabalhosa e envolve um volume excessivo de repetição se você optar por utilizar programas como Excel para resolvê-la. Dentre os vários critérios da lei, temos o critério de Meio Ambiente, e o órgão responsável pelo cálculo do índice referente a esse critério, é a SEMAD-MG (Secretaria de Estado de Meio Ambiente e Desenvolvimento Sustentável). Um dia, a SEMAD chegou até nós da Fundação João Pinheiro (FJP), pedindo por todos os valores de ICMS transferidos para cada município, ao longo dos anos de 2018 e 2019, de acordo com o critério do Meio Ambiente da Lei Robin Hood.</p>
<p>Os funcionários da FJP, calculam e publicam todo mês, os valores transferidos de ICMS separados por cada critério da lei, e para cada município. Ou seja, para o ano de 2019, pense por exemplo, em uma lista de arquivos de Excel parecida com a lista abaixo, onde cada planilha corresponde aos valores de ICMS transferidos em um mês específico do ano.</p>
<p>Dando uma olhada mais de perto, cada uma dessas planilhas do Excel, assumem a estrutura abaixo. Onde cada linha da tabela, representa um município do estado de Minas Gerais, e cada coluna (ou pelo menos, grande parte dessas colunas), representa os valores de ICMS transferidos segundo os índices de um critério específico da lei. Ou seja, a coluna <code>Educação</code>, nos apresenta os valores de ICMS transferidos para cada município do estado, considerando-se o índice que cada um desses municípios adquiriram no critério de Educação, e também, considerando-se a parcela que o critério de Educação representa do total de ICMS distribuído.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readxl)</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>Abril_2019 <span class="ot">&lt;-</span> <span class="fu">read_excel</span>(<span class="st">"./../Dados/planilhas/Abril_2019.xlsx"</span>)</span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>Abril_2019</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 853 × 27
   IBGE1 IBGE2   SEF Municípios          População População dos 50 + Populoso…¹
   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;                   &lt;dbl&gt;                         &lt;dbl&gt;
1 310010    10     1 ABADIA DOS DOURADOS     8847.                             0
2 310020    20     2 ABAETÉ                 29470.                             0
3 310030    30     3 ABRE CAMPO             17087.                             0
4 310040    40     4 ACAIACA                 5068.                             0
5 310050    50     5 AÇUCENA                12151.                             0
# ℹ 848 more rows
# ℹ abbreviated name: ¹​`População dos 50 + Populosos`</code></pre>
</div>
</div>
<p>Porém, temos dois problemas aqui: 1) A SEMAD precisa apenas dos valores de ICMS transferidos de acordo com o critério de Meio Ambiente, e nada mais; 2) A SEMAD precisa dos valores de ICMS transferidos ao longo de todos os meses dos anos de 2018 e 2019, e se nós temos 12 planilhas por ano, temos que reunir informações de 24 planilhas diferentes para a secretaria.</p>
<p>Portanto, temos aqui uma típica tarefa extremamente repetitiva e monótona, que ninguém gosta de fazer. Imagine você abrindo na mão, cada uma das 24 planilhas, procurando pela coluna do Meio Ambiente, copiando e colando ela em um novo arquivo contendo apenas os dados de Meio Ambiente, preenchendo colunas de ano e mês para manter a rastreabilidade dos registros, etc. Aqueles com mais experiência no Excel, poderiam argumentar que uma solução mais segura, seria utilizar a plataforma de <em>queries</em> do programa para carregar os dados das 24 planilhas em uma planilha única. Porém, apenas pelo tempo que você levaria para importar cada arquivo e configurar cada <em>querie</em>, seria muito mais rápido se você simplesmente adotasse a estratégia de <code>Crtl+C</code> e <code>Ctrl+V</code>, para transferir todos os dados para uma planilha única.</p>
<p>Além disso, tarefas muito repetitivas são, não apenas muito cansativas, mas também, muito <em>error-prone</em> (ou seja, elas elevam muito as suas chances de erros). Esses são dois fatores que podem ser facilmente evitados através do uso de funções e de <em>loop</em>’s no R. Ao construir uma função que define as ações que você deseja aplicar, e um <em>loop</em> que replique essa função para todas as x planilhas, você permite que o seu computador realize o trabalho duro e cansativo por você. Com isso, as suas chances de erro se reduzem muito, e você realiza o mesmo trabalho em menor tempo. Pois os nossos computadores são extremamente rápidos e precisos para realizar todo tipo de cálculo. Afinal, é para isso que eles foram feitos.</p>
</section>
<section id="planejando-os-passos" class="level3" data-number="16.7.2">
<h3 data-number="16.7.2" class="anchored" data-anchor-id="planejando-os-passos"><span class="header-section-number">16.7.2</span> Planejando os passos</h3>
<p>Como exemplo prático, para formatar os arquivos segundo as necessidades da SEMAD-MG, vou demonstrar as seguintes etapas: 1) importar essas planilhas para o R; 2) adicionar colunas de referência para cada planilha (ano e mês a que os dados se referem); 3) unir todas as planilhas em uma tabela única; 4) selecionar apenas as colunas relevantes para a SEMAD; 5) exportar o resultado para fora do R.</p>
</section>
<section id="importando-as-planilhas" class="level3" data-number="16.7.3">
<h3 data-number="16.7.3" class="anchored" data-anchor-id="importando-as-planilhas"><span class="header-section-number">16.7.3</span> Importando as planilhas</h3>
<p>Tendo isso em mente, o primeiro passo seria importarmos essas planilhas. Mas, para isso precisamos dos <em>path</em>’s, ou, dos caminhos até esses arquivos. Podemos coletar essa informação, através da função <code>list.files()</code>, a qual pertence aos pacotes básicos do R. Como o próprio nome dá a entender, essa função busca listar os nomes de todos os arquivos contidos em determinada uma pasta. Caso você não defina alguma pasta específica na função (diferente do que fizemos abaixo), <code>list.files()</code> vai listar todos os arquivos presentes no seu diretório de trabalho atual do R.</p>
<p>Neste exemplo, todas as 12 planilhas já estão separadas dentro de uma pasta de meu computador chamada <code>"planilhas"</code>. Por isso, forneço abaixo o nome dessa pasta à função <code>list.files()</code>. Como resultado, o objeto <code>caminhos</code> contém o caminho até todas essas planilhas que desejamos importar para dentro do R.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>caminhos <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="st">"./../Dados/planilhas/"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>caminhos</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "./../Dados/planilhas//Abril_2019.xlsx"    
 [2] "./../Dados/planilhas//Agosto_2019.xlsx"   
 [3] "./../Dados/planilhas//Dezembro_2019.xlsx" 
 [4] "./../Dados/planilhas//Fevereiro_2019.xlsx"
 [5] "./../Dados/planilhas//Janeiro_2019.xlsx"  
 [6] "./../Dados/planilhas//Julho_2019.xlsx"    
 [7] "./../Dados/planilhas//Junho_2019.xlsx"    
 [8] "./../Dados/planilhas//Maio_2019.xlsx"     
 [9] "./../Dados/planilhas//Marco_2019.xlsx"    
[10] "./../Dados/planilhas//Novembro_2019.xlsx" 
[11] "./../Dados/planilhas//Outubro_2019.xlsx"  
[12] "./../Dados/planilhas//Setembro_2019.xlsx" </code></pre>
</div>
</div>
<p>Agora que temos os caminhos até todas essas planilhas, importá-las para dentro do R se torna algo extremamente simples. Podemos simplesmente utilizar a função <code>map()</code> para aplicar uma função (que seja capaz de ler esses arquivos) sobre cada um desses caminhos. Lembre-se que, podemos importar planilhas do Excel para dentro do R, através da função <code>readxl::read_excel()</code> que introduzimos no capítulo 4.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readxl)</span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(purrr)</span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a>planilhas <span class="ot">&lt;-</span> <span class="fu">map</span>(caminhos, read_excel)</span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a>planilhas[[<span class="dv">1</span>]]</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 853 × 27
   IBGE1 IBGE2   SEF Municípios          População População dos 50 + Populoso…¹
   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;                   &lt;dbl&gt;                         &lt;dbl&gt;
1 310010    10     1 ABADIA DOS DOURADOS     8847.                             0
2 310020    20     2 ABAETÉ                 29470.                             0
3 310030    30     3 ABRE CAMPO             17087.                             0
4 310040    40     4 ACAIACA                 5068.                             0
5 310050    50     5 AÇUCENA                12151.                             0
# ℹ 848 more rows
# ℹ abbreviated name: ¹​`População dos 50 + Populosos`</code></pre>
</div>
</div>
<p>Agora, o objeto <code>planilhas</code> é uma lista de 12 elementos. Cada elemento dessa lista, contém um <code>data.frame</code> que corresponde aos dados de uma das 12 planilhas.</p>
</section>
<section id="conferindo-a-estrutura-dos-arquivos" class="level3" data-number="16.7.4">
<h3 data-number="16.7.4" class="anchored" data-anchor-id="conferindo-a-estrutura-dos-arquivos"><span class="header-section-number">16.7.4</span> Conferindo a estrutura dos arquivos</h3>
<p>Vamos aproveitar que já importamos as 12 planilhas, para fazermos algumas conferências sobre esses arquivos. Será que todas as planilhas possuem a mesma estrutura (o mesmo número de linhas, as mesmas colunas, os mesmos tipos de dados, etc.) ? Logo abaixo, estamos utilizando a função <code>nrow()</code> para coletarmos os números de linhas de cada tabela, <code>ncol()</code> para o número de colunas, e <code>colnames()</code> para os nomes das colunas. Perceba abaixo, que todas as planilhas possuem o mesmo número de linhas e colunas.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>n_linhas <span class="ot">&lt;-</span> <span class="fu">map_int</span>(planilhas, nrow)</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(n_linhas)</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] 853 853 853 853 853 853 853 853 853 853 853 853</code></pre>
</div>
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>n_colunas <span class="ot">&lt;-</span> <span class="fu">map_int</span>(planilhas, ncol)</span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(n_colunas)</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] 27 27 27 27 27 27 27 27 27 27 27 27</code></pre>
</div>
</div>
<p>Para conferirmos os nomes das colunas temos um pouco mais de trabalho, mas nada que seja muito distante do que foi mostrado até o momento.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>nomes_colunas <span class="ot">&lt;-</span> <span class="fu">map</span>(planilhas, colnames)</span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>referencia <span class="ot">&lt;-</span> nomes_colunas[[<span class="dv">1</span>]]</span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a>igual_a_referencia <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">"logical"</span>, <span class="at">length =</span> <span class="dv">12</span>)</span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="fu">seq_along</span>(nomes_colunas)){</span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a>  igual_a_referencia[i] <span class="ot">&lt;-</span> <span class="fu">all</span>(nomes_colunas[[i]] <span class="sc">==</span> referencia)</span>
<span id="cb96-7"><a href="#cb96-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb96-8"><a href="#cb96-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-9"><a href="#cb96-9" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(igual_a_referencia) <span class="ot">&lt;-</span> caminhos</span>
<span id="cb96-10"><a href="#cb96-10" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(igual_a_referencia)</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    ./../Dados/planilhas//Abril_2019.xlsx 
                                     TRUE 
   ./../Dados/planilhas//Agosto_2019.xlsx 
                                     TRUE 
 ./../Dados/planilhas//Dezembro_2019.xlsx 
                                    FALSE 
./../Dados/planilhas//Fevereiro_2019.xlsx 
                                     TRUE 
  ./../Dados/planilhas//Janeiro_2019.xlsx 
                                     TRUE 
    ./../Dados/planilhas//Julho_2019.xlsx 
                                     TRUE 
    ./../Dados/planilhas//Junho_2019.xlsx 
                                     TRUE 
     ./../Dados/planilhas//Maio_2019.xlsx 
                                     TRUE 
    ./../Dados/planilhas//Marco_2019.xlsx 
                                     TRUE 
 ./../Dados/planilhas//Novembro_2019.xlsx 
                                    FALSE 
  ./../Dados/planilhas//Outubro_2019.xlsx 
                                     TRUE 
 ./../Dados/planilhas//Setembro_2019.xlsx 
                                     TRUE </code></pre>
</div>
</div>
<p>Perceba pelo resultado acima, que os arquivos <code>Dezembro_2019.xlsx</code> e <code>Novembro_2019.xlsx</code> possuem alguma divergência no nome de suas colunas. Podemos rapidamente descobrir que colunas são essas com um simples teste lógico e <em>subsetting</em>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Coluna diferente no arquivo Dezembro_2019.xlsx</span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>nomes_colunas[[<span class="dv">3</span>]][ <span class="sc">!</span>referencia <span class="sc">==</span> nomes_colunas[[<span class="dv">3</span>]] ]</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "cota minima"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Coluna diferente no arquivo Novembro_2019.xlsx</span></span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>nomes_colunas[[<span class="dv">10</span>]][ <span class="sc">!</span>referencia <span class="sc">==</span> nomes_colunas[[<span class="dv">10</span>]] ]</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "cota minima"</code></pre>
</div>
</div>
<p>Pelos resultados acima, podemos observar que as duas planilhas possuem uma coluna chamada <code>cota minima</code>, a qual não está presente nas demais planilhas. Essa mesma coluna está nomeada como <code>Cota Mínima</code>, nas demais planilhas. Como resultado, caso você estivesse aplicando um <em>loop</em> sobre cada uma das 12 planilhas, e estivesse procurando por uma coluna chamada <code>Cota Mínima</code> em cada uma delas, o R não seria capaz de encontrar essa coluna nos arquivos <code>Dezembro_2019.xlsx</code> e <code>Novembro_2019.xlsx</code>.</p>
<p>Pelo fato de estarmos preocupados com a coluna de <code>Meio Ambiente</code>, essa diferença se torna um pouco irrelevante para nós. Entretanto, caso estivéssemos trabalhando com essa coluna de <code>Cota Mínima</code> em cada planilha, teríamos um grande problema a ser resolvido.</p>
</section>
<section id="adicionando-colunas-de-referência" class="level3" data-number="16.7.5">
<h3 data-number="16.7.5" class="anchored" data-anchor-id="adicionando-colunas-de-referência"><span class="header-section-number">16.7.5</span> Adicionando colunas de referência</h3>
<p>Apesar de já termos importado todas as 12 planilhas, temos um grande problema a ser solucionado. Os dados de cada planilha não possuem qualquer coluna ou metadado de referência que indique o período ao qual os dados se referem.</p>
<p>Dito de outra forma, ao olharmos para os dados da primeira planilha, podemos ver os valores monetários de cada município para cada critério. Porém, a que mês esses valores monetários se referem? Dezembro? Janeiro? Março? E de que ano? 2019? ou 2020?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>planilhas[[<span class="dv">1</span>]]</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 853 × 27
   IBGE1 IBGE2   SEF Municípios          População População dos 50 + Populoso…¹
   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;                   &lt;dbl&gt;                         &lt;dbl&gt;
1 310010    10     1 ABADIA DOS DOURADOS     8847.                             0
2 310020    20     2 ABAETÉ                 29470.                             0
3 310030    30     3 ABRE CAMPO             17087.                             0
4 310040    40     4 ACAIACA                 5068.                             0
5 310050    50     5 AÇUCENA                12151.                             0
# ℹ 848 more rows
# ℹ abbreviated name: ¹​`População dos 50 + Populosos`</code></pre>
</div>
</div>
<p>Sabemos que os dados dessa primeira planilha se referem ao mês de abril de 2019, pois essa informação está incrustada no nome da primeira planilha descrita no objeto <code>caminhos</code>, o qual utilizamos para importar todas as 12 planilhas. Porém, qualquer pessoa que não tenha acesso ao objeto <code>caminhos</code>, não será capaz de identificar tal informação.</p>
<p>Por isso, seria muito importante adicionarmos colunas de mês e ano em cada uma das 12 planilhas. Para isso, podemos aplicar os comandos abaixo. Pelo fato do mês e do ano de cada planilha estarem definidos nos próprios nomes dos arquivos, os primeiros comandos buscam extrair essas informações a partir do objeto <code>caminhos</code>. Depois disso, utilizamos um <code>for</code> <em>loop</em> para adicionar essas informações a cada uma 12 tabelas.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>nomes_arquivos <span class="ot">&lt;-</span> <span class="fu">basename</span>(caminhos)</span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>meses <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_replace</span>(</span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a>  nomes_arquivos, <span class="st">"(.*)_(.*)[.]xlsx"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">1"</span></span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-7"><a href="#cb104-7" aria-hidden="true" tabindex="-1"></a>anos <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_replace</span>(</span>
<span id="cb104-8"><a href="#cb104-8" aria-hidden="true" tabindex="-1"></a>  nomes_arquivos, <span class="st">"(.*)_(.*)[.]xlsx"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">2"</span></span>
<span id="cb104-9"><a href="#cb104-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb104-10"><a href="#cb104-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-11"><a href="#cb104-11" aria-hidden="true" tabindex="-1"></a>anos <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(anos)</span>
<span id="cb104-12"><a href="#cb104-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-13"><a href="#cb104-13" aria-hidden="true" tabindex="-1"></a><span class="do">### Um for loop para visitar cada uma das</span></span>
<span id="cb104-14"><a href="#cb104-14" aria-hidden="true" tabindex="-1"></a><span class="do">### 12 planilhas e adicionar as colunas Ano e Mes:</span></span>
<span id="cb104-15"><a href="#cb104-15" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="fu">seq_along</span>(planilhas)){</span>
<span id="cb104-16"><a href="#cb104-16" aria-hidden="true" tabindex="-1"></a>  planilhas[[i]] <span class="ot">&lt;-</span> planilhas[[i]] <span class="sc">%&gt;%</span> </span>
<span id="cb104-17"><a href="#cb104-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb104-18"><a href="#cb104-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">Ano =</span> anos[i],</span>
<span id="cb104-19"><a href="#cb104-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">Mes =</span> meses[i]</span>
<span id="cb104-20"><a href="#cb104-20" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb104-21"><a href="#cb104-21" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb104-22"><a href="#cb104-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-23"><a href="#cb104-23" aria-hidden="true" tabindex="-1"></a><span class="do">### Os dados de Abril de 2019:</span></span>
<span id="cb104-24"><a href="#cb104-24" aria-hidden="true" tabindex="-1"></a>planilhas[[<span class="dv">1</span>]] <span class="sc">%&gt;%</span> <span class="fu">select</span>(Ano, Mes)</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 853 × 2
    Ano Mes  
  &lt;int&gt; &lt;chr&gt;
1  2019 Abril
2  2019 Abril
3  2019 Abril
4  2019 Abril
5  2019 Abril
# ℹ 848 more rows</code></pre>
</div>
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="do">### Os dados de Dezembro de 2019:</span></span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>planilhas[[<span class="dv">3</span>]] <span class="sc">%&gt;%</span> <span class="fu">select</span>(Ano, Mes)</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 853 × 2
    Ano Mes     
  &lt;int&gt; &lt;chr&gt;   
1  2019 Dezembro
2  2019 Dezembro
3  2019 Dezembro
4  2019 Dezembro
5  2019 Dezembro
# ℹ 848 more rows</code></pre>
</div>
</div>
</section>
<section id="selecionando-apenas-as-colunas-relevantes" class="level3" data-number="16.7.6">
<h3 data-number="16.7.6" class="anchored" data-anchor-id="selecionando-apenas-as-colunas-relevantes"><span class="header-section-number">16.7.6</span> Selecionando apenas as colunas relevantes</h3>
<p>Agora que adicionamos as colunas de referência a cada uma das 12 planilhas, podemos nos preocupar em selecionar apenas as colunas relevantes para a SEMAD de cada planilha. Para isso, podemos simplesmente aplicar a função <code>select()</code> que vimos no capítulo 4, sobre cada planilha.</p>
<p>Aqui, podemos nos aproveitar do argumento especial <code>...</code> da função <code>map()</code>. Lembre-se que <code>map()</code> utiliza esse argumento especial para coletar os argumentos que serão repassados para a função (<code>.f</code>) que estamos aplicando.</p>
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./../Figuras/map2.png" class="img-fluid figure-img" style="width:90.0%"></p>
<figcaption>Relembrando os argumentos de <code>map()</code></figcaption>
</figure>
</div>
</div>
</div>
<p>Lembre-se também, que os argumentos repassados serão constantes ao longo de todo o <em>loop</em>. Em outras palavras, esses argumentos serão sempre os mesmos em cada chamada da função <code>.f</code>. Logo, quando você digita um comando como <code>map(x, mean, na.rm = TRUE)</code>, a função <code>map()</code> vai sempre repassar o argumento <code>na.rm</code> com o valor <code>TRUE</code> em cada chamada à função <code>mean()</code>.</p>
<p>Para compreender como você pode se aproveitar desse argumento, pense em como você aplicaria a função <code>select()</code> sobre apenas 1 das 12 planilhas. Perceba abaixo, que estamos repassando os argumentos <code>Ano</code>, <code>Mes</code>, <code>IBGE1</code>, <code>Municípios</code> e <code>Meio Ambiente</code> à função.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>planilhas[[<span class="dv">1</span>]] <span class="sc">%&gt;%</span> </span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Ano, Mes, IBGE1, Municípios, <span class="st">`</span><span class="at">Meio Ambiente</span><span class="st">`</span>)</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 853 × 5
    Ano Mes    IBGE1 Municípios          `Meio Ambiente`
  &lt;int&gt; &lt;chr&gt;  &lt;dbl&gt; &lt;chr&gt;                         &lt;dbl&gt;
1  2019 Abril 310010 ABADIA DOS DOURADOS              0 
2  2019 Abril 310020 ABAETÉ                           0 
3  2019 Abril 310030 ABRE CAMPO                   10433.
4  2019 Abril 310040 ACAIACA                          0 
5  2019 Abril 310050 AÇUCENA                       7727.
# ℹ 848 more rows</code></pre>
</div>
</div>
<p>Essas são as colunas que estamos interessados em extrair de cada planilha. Ou seja, queremos sempre repassar esses 5 argumentos à função <code>select()</code>, pois desejamos selecionar sempre essas mesmas colunas de cada planilha. Tendo isso em mente, podemos aplicar o seguinte comando:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>planilhas <span class="ot">&lt;-</span> <span class="fu">map</span>(</span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a>  planilhas, select,</span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Argumentos repassados para select():</span></span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a>  Ano, Mes, IBGE1, Municípios, <span class="st">`</span><span class="at">Meio Ambiente</span><span class="st">`</span></span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="unindo-as-12-planilhas-em-uma-só" class="level3" data-number="16.7.7">
<h3 data-number="16.7.7" class="anchored" data-anchor-id="unindo-as-12-planilhas-em-uma-só"><span class="header-section-number">16.7.7</span> Unindo as 12 planilhas em uma só</h3>
<p>Temos agora, uma lista contendo todas as 12 planilhas com apenas as colunas que a SEMAD necessita. Porém, lembre-se que cada planilha, está atualmente separada em um elemento diferente da lista. Nós estabelecemos anteriormente, que o ideal seria reunirmos todas essas 12 tabelas, em uma só.</p>
<p>Para executarmos esse passo, nós podemos simplesmente aplicar a função <code>bind_rows()</code> (que introduzimos no capítulo 4) sobre a lista <code>planilhas</code>. Se nós temos 12 planilhas diferentes, onde, cada linha de cada planilha representa um dos 853 municípios de Minas Gerais, ao unirmos todas essas tabelas, devemos ter como resultado, uma única tabela contendo 10.236 linhas (<span class="math inline">\(853 \times 12 = 10.236\)</span>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a>resultado <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(planilhas)</span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a>resultado</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10,236 × 5
    Ano Mes    IBGE1 Municípios          `Meio Ambiente`
  &lt;int&gt; &lt;chr&gt;  &lt;dbl&gt; &lt;chr&gt;                         &lt;dbl&gt;
1  2019 Abril 310010 ABADIA DOS DOURADOS              0 
2  2019 Abril 310020 ABAETÉ                           0 
3  2019 Abril 310030 ABRE CAMPO                   10433.
4  2019 Abril 310040 ACAIACA                          0 
5  2019 Abril 310050 AÇUCENA                       7727.
# ℹ 10,231 more rows</code></pre>
</div>
</div>
<p>Contudo, se você relembrar da função <code>map_dfr()</code> que expomos anteriormente, você pode chegar à conclusão de que poderíamos ter eliminado esse passo, ao utilizarmos essa função <code>map_dfr()</code> para aplicarmos a função <code>select()</code> sobre cada planilha. Pois, como destacamos, a função <code>map_dfr()</code> vai aplicar a função <code>.f</code> sobre cada elemento de <code>.x</code> e, em seguida, vai tentar unir todos os resultados em um único <code>data.frame</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Todos os resultados já são armazenados</span></span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a><span class="do">## em um único data.frame:</span></span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a>resultado <span class="ot">&lt;-</span> <span class="fu">map_dfr</span>(</span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a>  planilhas, select,</span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Argumentos repassados para select():</span></span>
<span id="cb113-6"><a href="#cb113-6" aria-hidden="true" tabindex="-1"></a>  Ano, Mes, IBGE1, Municípios, <span class="st">`</span><span class="at">Meio Ambiente</span><span class="st">`</span></span>
<span id="cb113-7"><a href="#cb113-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="conclusão" class="level3" data-number="16.7.8">
<h3 data-number="16.7.8" class="anchored" data-anchor-id="conclusão"><span class="header-section-number">16.7.8</span> Conclusão</h3>
<p>Portanto, uma tarefa que inicialmente seria trabalhosa e extremamente repetitiva em muitos programas comuns (como o Excel), pode ser resolvida no R de maneira fácil e rápida, através do uso das funções <code>map()</code>.</p>
<p>Tínhamos como objetivo, reunir os dados presentes em 12 planilhas em uma única tabela, e em seguida, selecionar apenas aquelas colunas que eram de interesse da SEMAD. Se reunirmos todos os comandos que utilizamos no R, temos um <em>script</em> com mais ou menos 30 linhas. Ou seja, com apenas 30 linhas, somos capazes de economizar um tempo e esforço enormes em nosso trabalho.</p>
<p>A partir daqui, com a tabela única em nossas mãos, nós precisamos apenas exportar essa tabela para fora do R. Algo que pode ser rapidamente realizado através de uma função como a <code>write_csv2()</code>, que introduzimos na seção <a href="#sec:exportando_readr">Exportando dados em arquivos de texto com readr</a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a>caminhos <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="st">"./../Dados/planilhas/"</span>)</span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a>planilhas <span class="ot">&lt;-</span> <span class="fu">map</span>(caminhos, planilhas)</span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a>nomes_arquivos <span class="ot">&lt;-</span> <span class="fu">basename</span>(caminhos)</span>
<span id="cb114-5"><a href="#cb114-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-6"><a href="#cb114-6" aria-hidden="true" tabindex="-1"></a>meses <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_replace</span>(</span>
<span id="cb114-7"><a href="#cb114-7" aria-hidden="true" tabindex="-1"></a>  nomes_arquivos, <span class="st">"(.*)_(.*)[.]xlsx"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">1"</span></span>
<span id="cb114-8"><a href="#cb114-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb114-9"><a href="#cb114-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-10"><a href="#cb114-10" aria-hidden="true" tabindex="-1"></a>anos <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_replace</span>(</span>
<span id="cb114-11"><a href="#cb114-11" aria-hidden="true" tabindex="-1"></a>  nomes_arquivos, <span class="st">"(.*)_(.*)[.]xlsx"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">2"</span></span>
<span id="cb114-12"><a href="#cb114-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb114-13"><a href="#cb114-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-14"><a href="#cb114-14" aria-hidden="true" tabindex="-1"></a>anos <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(anos)</span>
<span id="cb114-15"><a href="#cb114-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-16"><a href="#cb114-16" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="fu">seq_along</span>(planilhas)){</span>
<span id="cb114-17"><a href="#cb114-17" aria-hidden="true" tabindex="-1"></a>  planilhas[[i]] <span class="ot">&lt;-</span> planilhas[[i]] <span class="sc">%&gt;%</span> </span>
<span id="cb114-18"><a href="#cb114-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb114-19"><a href="#cb114-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">Ano =</span> anos[i],</span>
<span id="cb114-20"><a href="#cb114-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">Mes =</span> meses[i]</span>
<span id="cb114-21"><a href="#cb114-21" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb114-22"><a href="#cb114-22" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb114-23"><a href="#cb114-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-24"><a href="#cb114-24" aria-hidden="true" tabindex="-1"></a>resultado <span class="ot">&lt;-</span> <span class="fu">map_dfr</span>(</span>
<span id="cb114-25"><a href="#cb114-25" aria-hidden="true" tabindex="-1"></a>  planilhas, select,</span>
<span id="cb114-26"><a href="#cb114-26" aria-hidden="true" tabindex="-1"></a>  Ano, Mes, IBGE1, Municípios, <span class="st">`</span><span class="at">Meio Ambiente</span><span class="st">`</span></span>
<span id="cb114-27"><a href="#cb114-27" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb114-28"><a href="#cb114-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-29"><a href="#cb114-29" aria-hidden="true" tabindex="-1"></a><span class="do">### Para exportar o resultado:</span></span>
<span id="cb114-30"><a href="#cb114-30" aria-hidden="true" tabindex="-1"></a>readr<span class="sc">::</span><span class="fu">write_csv2</span>(</span>
<span id="cb114-31"><a href="#cb114-31" aria-hidden="true" tabindex="-1"></a>  resultado, <span class="st">"tabela_para_SEMAD.csv"</span></span>
<span id="cb114-32"><a href="#cb114-32" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="iterando-sobre-vários-inputs-simultaneamente" class="level2" data-number="16.8">
<h2 data-number="16.8" class="anchored" data-anchor-id="iterando-sobre-vários-inputs-simultaneamente"><span class="header-section-number">16.8</span> Iterando sobre vários <em>input</em>’s simultaneamente</h2>
<p>A medida em que você vai ganhando familiaridade com a família <code>map</code> de funções, você vai sentir a necessidade de expandir ainda mais as suas funcionalidades. Parte dessa expansão, reside em aplicar o <em>loop</em> implícito sobre um número maior de <em>input</em>’s. Por esse motivo, o pacote <code>purrr</code> também nos oferece as famílias <code>map2</code> e <code>pmap</code> de funções.</p>
<section id="utilizando-dois-inputs" class="level3" data-number="16.8.1">
<h3 data-number="16.8.1" class="anchored" data-anchor-id="utilizando-dois-inputs"><span class="header-section-number">16.8.1</span> Utilizando dois <em>input</em>’s</h3>
<p>Como o próprio nome dá a entender, a única diferença entre as famílias <code>map</code> e <code>map2</code>, é que as funções <code>map2</code> recebem 2 objetos (<code>.x</code> e <code>.y</code>) diferentes de <em>input</em>. Ou seja, as funções <code>map2</code> buscam aplicar a função <code>.f</code> sobre cada elemento de <code>.x</code> e de <code>.y</code> de forma simultânea. Em mais detalhes, cada elemento de <code>.x</code> é repassado como primeiro argumento de <code>.f</code>, enquanto cada elemento de <code>.y</code> é posicionado no segundo argumento de <code>.f</code>.</p>
<p>Vale destacar que o <em>loop</em> (criado pela função <code>map2</code> em questão) é aplicado de forma paralela sobre os objetos <code>.x</code> e <code>.y</code>. Ou seja, na primeira iteração, serão utilizados os elementos <code>.x[[1]]</code> e <code>.y[[1]]</code>, na segunda iteração, os elementos <code>.x[[2]]</code> e <code>.y[[2]]</code>, e assim por diante. A <a href="#fig-map2-simples" class="quarto-xref">Figura&nbsp;<span>16.5</span></a> apresenta tal <em>loop</em> de maneira gráfica:</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-map2-simples" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-map2-simples-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./../Figuras/map2_simple.png" class="img-fluid figure-img" style="width:80.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-map2-simples-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figura&nbsp;16.5: Representação da tarefa executada pela função <code>map_dbl()</code>
</figcaption>
</figure>
</div>
</div>
</div>
<p>Além disso, a família <code>map2</code> também tem um membro para cada estrutura de dado que você deseja retornar. Logo, a função <code>map2()</code> retorna uma lista, <code>map2_chr()</code>, um vetor do tipo <code>character</code>, <code>map2_dfr()</code>, um <code>data.frame</code>, e assim por diante.</p>
<p>Como exemplo, suponha que você tivesse os dois vetores (<code>x</code> e <code>y</code>) abaixo. Agora, suponha também que você desejasse compilar os menores números possíveis entre esses dois vetores. Ou seja, você deseja encontrar o menor número entre cada elemento de <code>x</code> e <code>y</code>. Você poderia realizar esse trabalho, através das funções <code>map2_int()</code> e <code>min()</code>, como demonstrado abaixo:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">2</span>L, <span class="dv">6</span>L, <span class="dv">9</span>L)</span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>L, <span class="dv">7</span>L, <span class="dv">4</span>L)</span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a><span class="fu">map2_int</span>(x, y, min)</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1 6 4</code></pre>
</div>
</div>
<p>É importante frisar, que os objetos <code>.x</code> e <code>.y</code> precisam necessariamente ter o mesmo comprimento. Caso você não respeite essa regra, um erro será levantado pela função <code>map2</code> que você está utilizando.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="fu">map2</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, sum)</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<pre><code># Error: Mapped vectors must have consistent lengths:
# * `.x` has length 2
# * `.y` has length 3</code></pre>
</section>
<section id="utilizando-n-inputs" class="level3" data-number="16.8.2">
<h3 data-number="16.8.2" class="anchored" data-anchor-id="utilizando-n-inputs"><span class="header-section-number">16.8.2</span> Utilizando <span class="math inline">\(n\)</span> <em>input</em>’s</h3>
<p>Se é possível utilizarmos 1 ou 2 <em>input</em>’s diferentes em uma função <code>map</code>, porque não permitirmos também um número arbitrário de <em>input</em>’s ? Esse é exatamente o objetivo que a família <code>pmap</code> de funções busca cumprir.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-pmap-simples" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-pmap-simples-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./../Figuras/pmap_simple.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-pmap-simples-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figura&nbsp;16.6: Representação da tarefa executada pela função <code>pmap_dbl()</code>
</figcaption>
</figure>
</div>
</div>
</div>
<p>Assim como as demais famílias apresentadas até o momento, a família <code>pmap</code> também contém um membro para cada tipo de estrutura de dado que você deseja retornar. Sendo assim, <code>pmap_int()</code> retorna um vetor do tipo <code>integer</code>, enquanto <code>pmap()</code> retorna uma lista, e assim por diante.</p>
<p>Todavia, enquanto as funções <code>map</code> e <code>map2</code> podem receber um objeto qualquer em seus primeiros argumentos, uma função <code>pmap</code> recebe necessariamente uma lista (<code>.l</code>) em seu primeiro argumento. Essa lista deve conter todos os <em>input</em>’s sobre os quais você deseja aplicar o <em>loop</em>. Dito de outra forma, cada elemento dessa lista <code>.l</code> corresponde a um <em>input</em> diferente que será utilizado na função <code>.f</code>.</p>
<p>Isso significa que você deve armazenar todos os <em>input</em>’s (sobre os quais você deseja aplicar a função <code>.f</code>) dentro de uma lista, e, fornecer essa lista à função <code>pmap</code>. Apesar desse detalhe, uma função <code>pmap</code> aplica o <em>loop</em> de forma simultânea sobre todos os <em>input</em>’s (da mesma forma como ocorre com as funções <code>map</code> e <code>map2</code>).</p>
<p>Como resultado, se você fornece uma lista como <code>list(x, y, z)</code> à função <code>pmap</code>, na primeira iteração serão utilizados os elementos <code>x[[1]]</code>, <code>y[[1]]</code> e <code>z[[1]]</code>, já na segunda iteração, os elementos <code>x[[2]]</code>, <code>y[[2]]</code> e <code>z[[2]]</code>, e assim por diante. Esse processo está apresentado na <a href="#fig-pmap-simples" class="quarto-xref">Figura&nbsp;<span>16.6</span></a>.</p>
<p>Perceba também pela <a href="#fig-pmap-simples" class="quarto-xref">Figura&nbsp;<span>16.6</span></a>, que os elementos da lista <code>.l</code> são fornecidos como argumentos para a função <code>.f</code>, de acordo com a posição que eles ocupam na lista. Sendo assim, o primeiro elemento da lista <code>.l</code> é fornecido como primeiro argumento de <code>.f</code>, enquanto o segundo elemento, como segundo argumento de <code>.f</code>, e assim por diante.</p>
<p>A função <code>pmap</code> realiza essa correspondência por posição sempre que você não dá um nome específico para cada elemento da lista. Como exemplo, a função <code>rnorm()</code> possui 3 argumentos (<code>n</code>, <code>mean</code> e <code>sd</code>). Caso eu nomeie os elementos da lista <code>.l</code> de acordo com esses 3 argumentos, eu posso reorganizar esses <em>input</em>’s dentro da lista <code>.l</code> da maneira que eu bem entender. Pois nesse caso, a função <code>pmap</code> em questão, vai conectar cada argumento da função aos nomes dos elementos da lista <code>.l</code>.</p>
<p>Como exemplo, repare abaixo, que o primeiro elemento da lista <code>args</code> foi corretamente associado ao argumento <code>mean</code>, mesmo que esse argumento não seja o primeiro argumento da função <code>rnorm()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a>args <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">mean =</span> <span class="fu">c</span>(<span class="dv">15</span>, <span class="dv">50</span>, <span class="dv">500</span>), <span class="at">n =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">5</span>), <span class="at">sd =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">5</span>)</span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb119-5"><a href="#cb119-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-6"><a href="#cb119-6" aria-hidden="true" tabindex="-1"></a><span class="fu">pmap</span>(args, rnorm)</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
[1] 14.37355 15.18364

[[2]]
[1] 49.16437 51.59528 50.32951

[[3]]
[1] 495.8977 502.4371 503.6916 502.8789 498.4731</code></pre>
</div>
</div>
<p>Pelo fato de um <code>data.frame</code> ser essencialmente, uma lista nomeada que contém elementos de mesmo comprimento, podemos armazenar tranquilamente os nossos <em>input</em>’s em um <code>data.frame</code>, e fornecê-lo à função <code>pmap</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a>args <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">mean =</span> <span class="fu">c</span>(<span class="dv">15</span>, <span class="dv">50</span>, <span class="dv">500</span>), </span>
<span id="cb121-4"><a href="#cb121-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">n =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">5</span>),</span>
<span id="cb121-5"><a href="#cb121-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">sd =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">5</span>)</span>
<span id="cb121-6"><a href="#cb121-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb121-7"><a href="#cb121-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-8"><a href="#cb121-8" aria-hidden="true" tabindex="-1"></a><span class="fu">pmap</span>(args, rnorm)</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
[1] 14.37355 15.18364

[[2]]
[1] 49.16437 51.59528 50.32951

[[3]]
[1] 495.8977 502.4371 503.6916 502.8789 498.4731</code></pre>
</div>
</div>
<p>Um outro detalhe, é que assim como todas as funções <code>map</code> e <code>map2</code> que vimos até o momento, <code>pmap</code> também possui o argumento especial <code>...</code> para repassar argumentos específicos para a função <code>.f</code>. Logo, todo argumento que você fornecer após o (ou à direita do) argumento <code>.f</code>, são argumentos que serão sempre repassados à função <code>.f</code> em cada iteração do <em>loop</em>. No exemplo abaixo, estamos repassando os argumentos <code>na.rm = TRUE</code> e <code>names = TRUE</code> em todas as chamadas à função <code>quantile()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a>args <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.25</span>, <span class="fl">0.5</span>, <span class="fl">0.75</span>)</span>
<span id="cb123-3"><a href="#cb123-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb123-4"><a href="#cb123-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-5"><a href="#cb123-5" aria-hidden="true" tabindex="-1"></a>dists <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb123-6"><a href="#cb123-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="cn">NA</span>, <span class="fl">2.5</span>, <span class="fl">8.1</span>, <span class="fl">3.9</span>),</span>
<span id="cb123-7"><a href="#cb123-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="fl">42.2</span>, <span class="cn">NA</span>, <span class="fl">93.2</span>, <span class="fl">35.1</span>),</span>
<span id="cb123-8"><a href="#cb123-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="fl">0.9</span>, <span class="fl">27.1</span>, <span class="fl">5.3</span>, <span class="cn">NA</span>)</span>
<span id="cb123-9"><a href="#cb123-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb123-10"><a href="#cb123-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-11"><a href="#cb123-11" aria-hidden="true" tabindex="-1"></a>args<span class="sc">$</span>x <span class="ot">&lt;-</span> dists</span>
<span id="cb123-12"><a href="#cb123-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-13"><a href="#cb123-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-14"><a href="#cb123-14" aria-hidden="true" tabindex="-1"></a><span class="fu">pmap</span>(args, quantile, <span class="at">na.rm =</span> <span class="cn">TRUE</span>, <span class="at">names =</span> <span class="cn">TRUE</span>)</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
25% 
3.2 

[[2]]
 50% 
42.2 

[[3]]
 75% 
16.2 </code></pre>
</div>
</div>
</section>
</section>
<section id="a-família-walk" class="level2" data-number="16.9">
<h2 data-number="16.9" class="anchored" data-anchor-id="a-família-walk"><span class="header-section-number">16.9</span> A família <code>walk()</code></h2>
<p>O pacote <code>purrr</code>, também nos oferece a família <code>walk</code> de funções, a qual é composta por apenas três membros: <code>walk()</code>, <code>walk2()</code> e <code>pwalk()</code>. Em resumo, as funções <code>walk</code> funcionam da mesma maneira que as funções <code>map</code>, contudo, elas não retornam, por padrão, algum resultado para o usuário.</p>
<p>Em mais detalhes, as funções <code>walk</code> constroem o <em>loop</em> implícito e aplicam a função <code>.f</code> sobre cada elemento dos objetos de <em>input</em>. Porém, essas funções não coletam os resultados gerados pela função <code>.f</code> a cada iteração, até porque, uma função <code>walk</code> tem como pressuposto, que a função <code>.f</code> não retorna nenhum resultado.</p>
<p>Por esse motivo, você geralmente utiliza a família <code>walk</code>, quando você deseja aplicar o mesmo <em>loop</em> implícito da família <code>map</code>, mas não está preocupado em coletar os resultados gerados. Ou ainda, quando a função <code>.f</code> que você deseja aplicar, não retorna um resultado por padrão, e sim, imprime alguma informação em seu console, ou altera objetos, configurações e <em>environments</em> presentes em sua sessão. No exemplo abaixo, estou aplicando a função <code>print()</code> sobre cada elemento de <code>l</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a>l <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>)</span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a><span class="fu">walk</span>(l, print)</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1
[1] 2
[1] 3
[1] 4</code></pre>
</div>
</div>
<p>Como você já deve ter inferido, a função <code>walk()</code> aceita um objeto (<code>.x</code>) de <em>input</em> e uma função <code>.f</code>, enquanto a função <code>walk2()</code> aceita dois objetos (<code>.x</code> e <code>.y</code>) de <em>input</em> e uma função <code>.f</code>. Já a função <code>pwalk()</code> aceita uma lista (<code>.l</code>) contendo <span class="math inline">\(n\)</span> objetos de <em>input</em>, além de uma função <code>.f</code>. Assim como as demais funções que vimos ao longo desse capítulo, essas três funções também possuem o argumento especial <code>...</code>, com o qual podemos repassar argumentos para a função <code>.f</code> em todas as chamadas executadas.</p>
</section>
<section id="agregando-resultados-com-reduce" class="level2" data-number="16.10">
<h2 data-number="16.10" class="anchored" data-anchor-id="agregando-resultados-com-reduce"><span class="header-section-number">16.10</span> Agregando resultados com <code>reduce()</code></h2>
<p>Em algumas ocasiões, você tem uma lista complexa que você deseja reduzir para uma lista mais simples <span class="citation" data-cites="wickham2017">(<a href="references.html#ref-wickham2017" role="doc-biblioref">WICKHAM; GROLEMUND, 2017</a>)</span>. É em momentos como esse, que as funções <code>Reduce()</code> e <code>purrr::reduce()</code> se tornam extremamente úteis. Ambas as funções realizam exatamente o mesmo trabalho. A diferença entre elas, é que a função <code>Reduce()</code> pertence aos pacotes básicos do R, enquanto <code>reduce()</code> advém do pacote <code>purrr</code>.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-reduce" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-reduce-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./../Figuras/reduce.png" class="img-fluid figure-img" style="width:90.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-reduce-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figura&nbsp;16.7: Representação da combinação executada por <code>reduce()</code>
</figcaption>
</figure>
</div>
</div>
</div>
<p>Você possivelmente já conhece o termo <em>reduce</em>, especialmente se você já trabalhou com alguma outra linguagem de programação focada no paradigma FP. Mas esse termo também é muito associado ao modelo <em>MapReduce</em> que é comumente utilizado em ferramentas para processamento de <em>BigData</em>.</p>
<p>Em resumo, <code>reduce()</code> busca combinar todos os elementos de um objeto em um único valor. Ou seja, de certa forma, essa função <code>reduce()</code> calcula uma “agregação” dos elementos de um objeto. Esse processo combinatório de <code>reduce()</code> é uma operação bastante comum em diversos tipos de computação. Por isso, várias linguagens de programação oferecem uma função parecida com <code>reduce()</code>. Um exemplo é o método <code>functools.reduce()</code> da linguagem Python.</p>
<p>A forma como <code>reduce()</code> conduz essa combinação é na realidade, bastante simples. Considerando um objeto que possua 4 elementos como exemplo, <code>reduce()</code> vai primeiro, aplicar a função <code>.f</code> sobre os elementos 1 e 2, produzindo o resultado <code>r1</code>; em seguida, ela aplica novamente a função <code>.f</code> sobre o resultado anterior (<code>r1</code>) e o elemento 3, produzindo assim, o resultado <code>r2</code>; em seguida, ela aplica a função <code>.f</code> sobre o resultado anterior (<code>r2</code>), e o elemento 4, produzindo assim, o resultado final <code>r3</code>, que contém dentro de si, um resumo de todos os 4 elementos do objeto. Descrevendo de outra forma, o resultado de uma expressão como <code>reduce(1:4, f)</code> seria <code>f(f(f(1, 2), 3), 4)</code>. Tal processo de combinação está apresentado de maneira gráfica na <a href="#fig-reduce" class="quarto-xref">Figura&nbsp;<span>16.7</span></a>.</p>
<p>Um dos exemplos mais clássicos de uso da função <code>reduce()</code> ao longo de várias linguagens de programação, seria o cálculo de uma soma vetorizada. Ou seja, através da função <code>reduce()</code> conseguimos reproduzir a mesma funcionalidade da função <code>sum()</code>. No exemplo abaixo, a função <code>reduce()</code> está calculando o valor da expressão <code>(((1+2)+3)+4)+5</code>, que é basicamente o mesmo cálculo de <code>sum(1:5)</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="fu">reduce</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="st">`</span><span class="at">+</span><span class="st">`</span>)</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 15</code></pre>
</div>
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="do">## O mesmo cálculo:</span></span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>)</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 15</code></pre>
</div>
</div>
<p>Com esse exemplo em mente, podemos expandi-lo com facilidade para as demais operações aritméticas, como multiplicação, potência e divisão:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Multiplicação:</span></span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a><span class="fu">reduce</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="st">`</span><span class="at">*</span><span class="st">`</span>)</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 120</code></pre>
</div>
<div class="sourceCode cell-code" id="cb133"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Divisão:</span></span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a><span class="fu">reduce</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="st">`</span><span class="at">/</span><span class="st">`</span>)</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.008333333</code></pre>
</div>
<div class="sourceCode cell-code" id="cb135"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Potência:</span></span>
<span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a><span class="fu">reduce</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="st">`</span><span class="at">^</span><span class="st">`</span>)</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1</code></pre>
</div>
</div>
<p>Um outro exemplo em que <code>reduce()</code> se torna extremamente útil, seria quando desejamos unir vários <code>data.frame</code>’s através de <em>join</em>’s (os quais apresentamos no capítulo 6). Fica meio chato, escrevermos vários <em>join</em>’s separados para unirmos todas essas tabelas, e a função <code>reduce()</code> oferece uma maneira elegante e eficiente de resumirmos essa operação.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb137"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a>dias <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb137-2"><a href="#cb137-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">dia =</span> <span class="fu">seq.Date</span>(<span class="fu">as.Date</span>(<span class="st">"2021-12-01"</span>), <span class="fu">as.Date</span>(<span class="st">"2021-12-10"</span>), <span class="at">by =</span> <span class="st">"1 day"</span>)</span>
<span id="cb137-3"><a href="#cb137-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb137-4"><a href="#cb137-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-5"><a href="#cb137-5" aria-hidden="true" tabindex="-1"></a>savassi <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb137-6"><a href="#cb137-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">dia =</span> <span class="fu">c</span>(<span class="fu">as.Date</span>(<span class="st">"2021-12-01"</span>), <span class="fu">as.Date</span>(<span class="st">"2021-12-03"</span>), <span class="fu">as.Date</span>(<span class="st">"2021-12-05"</span>)),</span>
<span id="cb137-7"><a href="#cb137-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">vendas_savassi =</span> <span class="fu">c</span>(<span class="dv">1200</span>, <span class="dv">4500</span>, <span class="dv">3400</span>)</span>
<span id="cb137-8"><a href="#cb137-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb137-9"><a href="#cb137-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-10"><a href="#cb137-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-11"><a href="#cb137-11" aria-hidden="true" tabindex="-1"></a>centro <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb137-12"><a href="#cb137-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">dia =</span> <span class="fu">c</span>(</span>
<span id="cb137-13"><a href="#cb137-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.Date</span>(<span class="st">"2021-12-02"</span>), <span class="fu">as.Date</span>(<span class="st">"2021-12-03"</span>), <span class="fu">as.Date</span>(<span class="st">"2021-12-04"</span>),</span>
<span id="cb137-14"><a href="#cb137-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.Date</span>(<span class="st">"2021-12-05"</span>), <span class="fu">as.Date</span>(<span class="st">"2021-12-07"</span>), <span class="fu">as.Date</span>(<span class="st">"2021-12-10"</span>)</span>
<span id="cb137-15"><a href="#cb137-15" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb137-16"><a href="#cb137-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">vendas_centro =</span> <span class="fu">c</span>(<span class="dv">2400</span>, <span class="dv">3600</span>, <span class="dv">3100</span>, <span class="dv">1400</span>, <span class="dv">1500</span>, <span class="dv">2700</span>)</span>
<span id="cb137-17"><a href="#cb137-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb137-18"><a href="#cb137-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-19"><a href="#cb137-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-20"><a href="#cb137-20" aria-hidden="true" tabindex="-1"></a>barreiro <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb137-21"><a href="#cb137-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">dia =</span> <span class="fu">c</span>(</span>
<span id="cb137-22"><a href="#cb137-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.Date</span>(<span class="st">"2021-12-07"</span>), <span class="fu">as.Date</span>(<span class="st">"2021-12-08"</span>), <span class="fu">as.Date</span>(<span class="st">"2021-12-09"</span>)</span>
<span id="cb137-23"><a href="#cb137-23" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb137-24"><a href="#cb137-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">vendas_barreiro =</span> <span class="fu">c</span>(<span class="dv">5400</span>, <span class="dv">4500</span>, <span class="dv">8700</span>)</span>
<span id="cb137-25"><a href="#cb137-25" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb137-26"><a href="#cb137-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-27"><a href="#cb137-27" aria-hidden="true" tabindex="-1"></a><span class="do">### Unindo todas essas tabelas através de um FULL JOIN:</span></span>
<span id="cb137-28"><a href="#cb137-28" aria-hidden="true" tabindex="-1"></a><span class="fu">reduce</span>(<span class="fu">list</span>(dias, savassi, centro, barreiro), full_join, <span class="at">by =</span> <span class="st">"dia"</span>)</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          dia vendas_savassi vendas_centro vendas_barreiro
1  2021-12-01           1200            NA              NA
2  2021-12-02             NA          2400              NA
3  2021-12-03           4500          3600              NA
4  2021-12-04             NA          3100              NA
5  2021-12-05           3400          1400              NA
6  2021-12-06             NA            NA              NA
7  2021-12-07             NA          1500            5400
8  2021-12-08             NA            NA            4500
9  2021-12-09             NA            NA            8700
10 2021-12-10             NA          2700              NA</code></pre>
</div>
</div>
<p>Apesar da praticidade de <code>reduce()</code>, é importante que você conheça muito bem a operação que você está aplicando sobre os elementos. Pois a depender da forma como essa operação é realizada, a direção do processo combinatório realizado por <code>reduce()</code> pode te levar a diferentes resultados.</p>
<p>Como um primeiro exemplo, quando aplicamos o operador de potenciação (<code>^</code>) sobre o vetor <code>1:4</code>, o resultado gerado por <code>reduce()</code> é de 1. Pois a função calculou o valor da expressão <code>(((1^2)^3)^4)</code>. Ou seja, estamos elevando repetidamente 1 a um determinado número, e 1 elevado a qualquer coisa é sempre igual a 1.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb139"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a><span class="fu">reduce</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>, <span class="st">`</span><span class="at">^</span><span class="st">`</span>)</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1</code></pre>
</div>
</div>
<p>Se invertermos a ordem da combinação (através do argumento <code>.dir</code>), o mesmo resultado é retornado. Pois dessa forma, <code>reduce()</code> está calculando o valor da expressão <code>(1^(2^(3^4)))</code>. Ou seja, no fim das contas, ainda estamos elevando 1 a um número gigantesco.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb141"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a><span class="fu">reduce</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>, <span class="st">`</span><span class="at">^</span><span class="st">`</span>, <span class="at">.dir =</span> <span class="st">"backward"</span>)</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1</code></pre>
</div>
</div>
<p>Entretanto, não se engane por esse caso especial, ou por essa exceção à regra. Pois o resultado da operação de potenciação depende sim da ordem em que os elementos são combinados. Podemos enxergar isso, ao retirarmos o número 1 dessa expressão. Portanto, as expressões <code>((2^3)^4)</code> e <code>(2^(3^4))</code>, calculadas abaixo por <code>reduce()</code>, geram resultados diferentes, pois elas resultam em <span class="math inline">\(8^4\)</span> e <span class="math inline">\(2^{81}\)</span> (respectivamente).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb143"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a><span class="fu">reduce</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">4</span>, <span class="st">`</span><span class="at">^</span><span class="st">`</span>)</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 4096</code></pre>
</div>
<div class="sourceCode cell-code" id="cb145"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a><span class="fu">reduce</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">4</span>, <span class="st">`</span><span class="at">^</span><span class="st">`</span>, <span class="at">.dir =</span> <span class="st">"backward"</span>)</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2.417852e+24</code></pre>
</div>
</div>
<p>Como um segundo exemplo, perceba que a estrutura das listas <code>a</code> e <code>b</code> abaixo são diferentes, mesmo que ambas tenham sido construídas com base no mesmo objeto (<code>1:4</code>) e função (<code>list</code>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb147"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="fu">reduce</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>, list)</span>
<span id="cb147-2"><a href="#cb147-2" aria-hidden="true" tabindex="-1"></a>b <span class="ot">&lt;-</span> <span class="fu">reduce</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>, list, <span class="at">.dir =</span> <span class="st">"backward"</span>)</span>
<span id="cb147-3"><a href="#cb147-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-4"><a href="#cb147-4" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(a)</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 2
 $ :List of 2
  ..$ :List of 2
  .. ..$ : int 1
  .. ..$ : int 2
  ..$ : int 3
 $ : int 4</code></pre>
</div>
<div class="sourceCode cell-code" id="cb149"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(b)</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 2
 $ : int 1
 $ :List of 2
  ..$ : int 2
  ..$ :List of 2
  .. ..$ : int 3
  .. ..$ : int 4</code></pre>
</div>
</div>
<p>Sendo assim, a depender da função que você está aplicando através de <code>reduce()</code>, você terá que inverter a ordem da combinação através do argumento <code>.dir</code>, para chegar ao resultado que você deseja.</p>
</section>
<section id="acumulando-resultados-com-accumulate" class="level2" data-number="16.11">
<h2 data-number="16.11" class="anchored" data-anchor-id="acumulando-resultados-com-accumulate"><span class="header-section-number">16.11</span> Acumulando resultados com <code>accumulate()</code></h2>
<p>Se podemos combinar os diversos resultados gerados para produzir um único valor, também podemos “acumular” esses resultados, através da função <code>accumulate()</code>. Esse processo é um pouco diferente, pois, ao invés de produzir um único valor, ele acaba produzindo um novo objeto de mesmo comprimento que o objeto de <em>input</em>. Contudo, esse processo ainda herda parte da metodologia combinatória empregada por <code>reduce()</code>.</p>
<p>Como exemplo, quando utilizamos <code>accumulate()</code> para aplicar o operador de soma (<code>+</code>) sobre o vetor <code>1:4</code>, o resultado é a soma acumulada do vetor. Ou seja, a expressão abaixo é equivalente à expressão <code>cumsum(1:4)</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb151"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb151-1"><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a><span class="fu">accumulate</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>, <span class="st">`</span><span class="at">+</span><span class="st">`</span>)</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1]  1  3  6 10</code></pre>
</div>
</div>
<p>Com esse exemplo, podemos entender um pouco melhor o que <code>accumulate()</code> faz. Em resumo, <code>accumulate()</code> aplica o mesmo processo combinatório de <code>reduce()</code>, porém, ele armazena cada resultado gerado ao longo do processo. A <a href="#fig-accumulate" class="quarto-xref">Figura&nbsp;<span>16.8</span></a> traz uma representação do processo executado por <code>accumulate()</code>.</p>
<p>Perceba nessa figura, que para retornar um novo objeto de mesmo comprimento que o objeto de <em>input</em>, <code>accumulate()</code> precisa gerar um resultado para cada elemento deste objeto. Devido a essa regra, na primeira iteração, <code>accumulate()</code> precisa aplicar a função <code>.f</code> somente sobre o primeiro elemento do objeto de <em>input</em>, para nas próximas iterações, aplicar a função <code>.f</code> em pares.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-accumulate" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-accumulate-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./../Figuras/accumulate.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-accumulate-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figura&nbsp;16.8: Representação da tarefa executada por <code>accumulate()</code>
</figcaption>
</figure>
</div>
</div>
</div>
<p>Caso <code>accumulate()</code> não fizesse esse passo na primeira iteração, a função nos retornaria um novo objeto de <span class="math inline">\(n-1\)</span> elementos, para um objeto de <em>input</em> de <span class="math inline">\(n\)</span> elementos. O que desrespeitaria a regra de mesmo comprimento entre o <em>input</em> e <em>output</em> da função.</p>
<p>Descrevendo ainda de uma outra forma, a expressão <code>accumulate(1:4, f)</code> resulta em um vetor de 4 elementos, onde o primeiro elemento contém o resultado de <code>f(1)</code>; o segundo elemento, de <code>f(f(1),2)</code>; o terceiro elemento, de <code>f(f(f(1),2),3)</code>; e o quarto elemento, de <code>f(f(f(f(1),2),3),4)</code>.</p>
<p>Assim como ocorre em <code>reduce()</code>, <code>accumulate()</code> também possui um argumento <code>.dir</code> que define a direção do processo combinatório. Ao invertermos a ordem desse processo, os 4 elementos do vetor resultante da expressão <code>accumulate(1:4, f)</code> conteriam os resultados das expressões <code>f(f(f(f(4),3),2),1)</code>, <code>f(f(f(4),3),2)</code>, <code>f(f(4),3)</code> e <code>f(4)</code>, respectivamente.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb153"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a><span class="fu">accumulate</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>, <span class="st">`</span><span class="at">+</span><span class="st">`</span>, <span class="at">.dir =</span> <span class="st">"backward"</span>)</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 10  9  7  4</code></pre>
</div>
</div>


<div id="refs" class="references csl-bib-body" data-entry-spacing="1" role="list" style="display: none">
<div id="ref-wickham2017" class="csl-entry" role="listitem">
WICKHAM, H.; GROLEMUND, G. <strong><a href="https://r4ds.had.co.nz">R for Data Science</a></strong>. Sebastopol, CA: O’Reilly Media, Inc., 2017.
</div>
</div>
</section>
<section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr>
<ol>
<li id="fn1"><p>https://www.almg.gov.br/consulte/legislacao/completa/completa-nova-min.html?tipo=LEI&amp;num=18030&amp;comp=&amp;ano=2009&amp;texto=original<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copiada");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copiada");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../Capítulos/17-loops.html" class="pagination-link" aria-label="*Loops*">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title"><em>Loops</em></span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../Capítulos/15-debugging.html" class="pagination-link" aria-label="*Debugging* - Resolvendo *bugs* em suas funções">
        <span class="nav-page-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title"><em>Debugging</em> - Resolvendo <em>bugs</em> em suas funções</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>